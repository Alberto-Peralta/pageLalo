<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCO3FRhSwH1xLABwVGFSd_YYrbFp0lQEv8",
        authDomain: "pagelalo-1b210.firebaseapp.com",
        databaseURL: "https://pagelalo-1b210-default-rtdb.firebaseio.com",
        projectId: "pagelalo-1b210",
        storageBucket: "pagelalo-1b210.firebasestorage.app",
        messagingSenderId: "1096735980204",
        appId: "1:1096735980204:web:8252ddb9fb484c398dfd09"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const appId = 'default-app-id';
    
    let orderData = null;
    let products = [];
    
    const coupons = {
        'DESC20': { type: 'percentage', value: 20 },
        'ENVIO': { type: 'fixed', value: 50 },
        'PLATERIA10': { type: 'percentage', value: 10, targetProductId: 'P003' }, // Cupón exclusivo para "Collar de Plata"
        'CRUCES50': { type: 'fixed', value: 50, targetProductId: 'P001' } // Cupón exclusivo para "Cruz de Madera"
    };
    let appliedGlobalCoupon = null;

    function renderOrderDetails() {
        const container = document.getElementById('orderDetails');
        const productMap = products.reduce((acc, p) => ({ ...acc, [p.id]: p }), {});
        
        let subtotal = 0;
        let finalTotal = 0;
        let totalDiscount = 0;
        
        const itemsHtml = Object.entries(orderData.cart).map(([id, item]) => {
            const product = productMap[id];
            if (!product) return '';

            const qty = item.qty;
            const priceToUse = (product.offerPrice && product.offerPrice < product.price) ? product.offerPrice : product.price;
            let itemPrice = priceToUse * qty;
            let itemDiscount = 0;

            const coupon = coupons[item.couponCode];
            if (coupon && (!coupon.targetProductId || coupon.targetProductId === id)) {
                if (coupon.type === 'percentage') {
                    itemDiscount = itemPrice * (coupon.value / 100);
                } else if (coupon.type === 'fixed') {
                    itemDiscount = coupon.value;
                }
            }

            itemPrice -= itemDiscount;
            subtotal += priceToUse * qty;
            finalTotal += itemPrice;
            totalDiscount += itemDiscount;

            return `
                <div class="flex items-center bg-gray-50 p-4 rounded-xl gap-4 border border-gray-200">
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-20 h-20 object-cover rounded-lg shadow-sm">
                    <div class="flex-grow">
                        <h4 class="text-gray-800 font-semibold">${product.name}</h4>
                        <span class="text-gray-600 text-sm">Cantidad: ${qty}</span>
                        <div class="mt-2 flex items-center gap-2">
                            <input type="text" data-product-id="${id}" class="product-coupon-input w-24 p-1 text-xs bg-white rounded-lg border border-gray-300 focus:ring-1 focus:ring-yellow-500" placeholder="Cupón" value="${item.couponCode || ''}">
                            <button data-product-id="${id}" class="apply-product-coupon-btn bg-gray-800 text-white font-semibold py-1 px-2 rounded-lg text-xs hover:bg-gray-700 transition-colors">Aplicar</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-yellow-700 font-bold text-lg">$${(itemPrice).toFixed(2)}</p>
                        ${itemDiscount > 0 ? `<p class="text-xs text-green-600 font-semibold">- $${itemDiscount.toFixed(2)}</p>` : ''}
                    </div>
                </div>`;
        }).join('');

        const globalCouponDiscount = appliedGlobalCoupon && coupons[appliedGlobalCoupon.code] && !coupons[appliedGlobalCoupon.code].targetProductId 
            ? (coupons[appliedGlobalCoupon.code].type === 'percentage' ? finalTotal * (coupons[appliedGlobalCoupon.code].value / 100) : coupons[appliedGlobalCoupon.code].value)
            : 0;

        const finalDiscount = totalDiscount + globalCouponDiscount;
        const finalPrice = subtotal - finalDiscount;
        
        container.innerHTML = `
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Pedido #${orderData.orderNumber}</h2>
            </div>
            <div class="space-y-4 mb-6">${itemsHtml}</div>
            
            <div class="border-t border-gray-200 pt-4 mb-4">
                <div class="flex gap-2">
                    <input type="text" id="couponCodeInput" placeholder="Código de cupón general" class="w-full p-2 bg-gray-50 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500">
                    <button onclick="applyGlobalCoupon()" class="bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">Aplicar</button>
                </div>
                <div id="couponMessage" class="text-sm mt-2 text-center"></div>
            </div>

            <div id="totalsSection" class="border-t border-gray-200 pt-4 space-y-2">
                <div class="flex justify-between items-center text-md">
                    <span class="text-gray-600">Subtotal:</span>
                    <span class="text-gray-800 font-semibold">$${subtotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center text-md text-green-600">
                    <span>Descuento:</span>
                    <span id="discountValue" class="font-semibold">-$${finalDiscount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center text-xl">
                    <span class="text-gray-800 font-bold">Total:</span>
                    <span id="finalTotalValue" class="text-yellow-700 font-bold">$${finalPrice.toFixed(2)}</span>
                </div>
            </div>`;
        
        document.querySelectorAll('.apply-product-coupon-btn').forEach(btn => {
            btn.addEventListener('click', applyProductCoupon);
        });
    }

    async function applyProductCoupon(e) {
        const productId = e.target.dataset.productId;
        const input = document.querySelector(`.product-coupon-input[data-product-id="${productId}"]`);
        const code = input.value.trim().toUpperCase();

        if (!code) {
            const itemToUpdate = orderData.cart[productId];
            delete itemToUpdate.couponCode;
            alert('❌ Cupón de producto eliminado.');
            renderOrderDetails();
            return;
        }

        const coupon = coupons[code];

        if (coupon && (!coupon.targetProductId || coupon.targetProductId === productId)) {
            const itemToUpdate = orderData.cart[productId];
            itemToUpdate.couponCode = code;
            alert('✅ Cupón aplicado a este producto.');
        } else {
            alert('❌ Código de cupón no válido para este producto.');
        }
        renderOrderDetails();
    }

    window.applyGlobalCoupon = function() {
        const couponInput = document.getElementById('couponCodeInput');
        const messageDiv = document.getElementById('couponMessage');
        const code = couponInput.value.trim().toUpperCase();

        const coupon = coupons[code];
        if (coupon && !coupon.targetProductId) {
            appliedGlobalCoupon = { code, ...coupon };
            messageDiv.textContent = `¡Cupón "${code}" aplicado con éxito!`;
            messageDiv.className = 'text-sm mt-2 text-center text-green-600';
        } else {
            appliedGlobalCoupon = null;
            messageDiv.textContent = 'El código del cupón no es válido para todo el pedido.';
            messageDiv.className = 'text-sm mt-2 text-center text-red-600';
        }
        renderOrderDetails();
    }

    window.confirmOrder = async function() {
        const customerName = prompt('Por favor, ingresa tu nombre completo:');
        if (!customerName) return alert('El nombre es requerido.');
        const customerPhone = prompt('Ingresa tu número de teléfono (10 dígitos):');
        if (!customerPhone || !/^\d{10}$/.test(customerPhone)) return alert('El número de teléfono es inválido.');

        const productMap = products.reduce((acc, p) => ({ ...acc, [p.id]: p }), {});
        let finalTotal = 0;
        let subtotal = 0;
        let discountAmount = 0;

        Object.entries(orderData.cart).forEach(([id, item]) => {
            const product = productMap[id];
            if (!product) return;
            const priceToUse = (product.offerPrice && product.offerPrice < product.price) ? product.offerPrice : product.price;
            let itemPrice = priceToUse * item.qty;
            
            const coupon = coupons[item.couponCode];
            if (coupon && (!coupon.targetProductId || coupon.targetProductId === id)) {
                let itemDiscount = 0;
                if (coupon.type === 'percentage') {
                    itemDiscount = itemPrice * (coupon.value / 100);
                } else if (coupon.type === 'fixed') {
                    itemDiscount = coupon.value;
                }
                itemPrice -= itemDiscount;
                discountAmount += itemDiscount;
            }

            subtotal += priceToUse * item.qty;
            finalTotal += itemPrice;
        });

        const globalCoupon = appliedGlobalCoupon ? coupons[appliedGlobalCoupon.code] : null;
        if (globalCoupon && !globalCoupon.targetProductId) {
            let globalDiscount = 0;
            if (globalCoupon.type === 'percentage') {
                globalDiscount = finalTotal * (globalCoupon.value / 100);
            } else if (globalCoupon.type === 'fixed') {
                globalDiscount = globalCoupon.value;
            }
            finalTotal -= globalDiscount;
            discountAmount += globalDiscount;
        }

        const completeOrderData = {
            ...orderData,
            subtotal: subtotal,
            discount: discountAmount,
            total: finalTotal,
            couponUsed: appliedGlobalCoupon ? appliedGlobalCoupon.code : null,
            timestamp: Date.now(),
            status: 'pendiente',
            customerName: customerName.trim(),
            customerPhone: customerPhone.trim(),
        };
        
        await set(ref(db, `/artifacts/${appId}/public/orders/${orderData.orderId}`), completeOrderData);

        let msg = `¡Hola ${customerName}! 👋\n\n✅ Tu pedido en *El cielo en tus manos* ha sido registrado.\n✨ *Número de pedido:* ${orderData.orderNumber}\n\n`;
        if (discountAmount > 0) {
            msg += `Subtotal: $${subtotal.toFixed(2)}\n`;
            msg += `Descuento: -$${discountAmount.toFixed(2)}\n`;
        }
        msg += `💰 *Total a pagar:* $${finalTotal.toFixed(2)}\n\n`;
        msg += `📍 *Sigue el estado de tu pedido aquí:*\n${window.location.origin}/order-status.html\n\n¡Gracias por tu compra! 🙏`;

        window.open(`https://wa.me/52${customerPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        
        alert(`✅ Pedido #${orderData.orderNumber} confirmado. Se abrirá WhatsApp para enviar los detalles.`);
        setTimeout(() => { window.location.href = 'index.html'; }, 2000);
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const data = params.get('data');
        if (data) {
            orderData = JSON.parse(decodeURIComponent(data));
            onValue(ref(db, `/artifacts/${appId}/public/products`), (snapshot) => {
                products = snapshot.exists() ? Object.keys(snapshot.val()).map(id => ({ id, ...snapshot.val()[id] })) : [];
                renderOrderDetails();
            });
        }
    });
</script>