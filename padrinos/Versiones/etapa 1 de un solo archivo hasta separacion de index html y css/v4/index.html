<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Padrinos Misioneros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0);
            will-change: transform, box-shadow;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .file-input {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toast" class="toast hidden"><div class="flex items-center"><i id="toast-icon" class="fas fa-info-circle mr-2"></i><span id="toast-message"></span></div></div>

    <div id="loginScreen" class="login-container gradient-bg p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-4"><i class="fas fa-hands-helping text-blue-600 text-3xl"></i></div>
                <h1 class="text-3xl font-bold text-gray-800">Padrinos Misioneros</h1>
                <p class="text-gray-600 mt-2">Inicia sesión para gestionar tus padrinos</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label><input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300" placeholder="tu@email.com"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label><input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300" placeholder="Tu contraseña"></div>
                <div id="loginError" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>
                <button type="submit" id="loginBtn" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center"><span id="loginText">Iniciar Sesión</span><div id="loginSpinner" class="spinner hidden ml-2"></div></button>
            </form>
            <p class="text-center text-gray-500 text-sm mt-6">¿Necesitas acceso? Contacta al administrador.</p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3"><i class="fas fa-hands-helping text-2xl"></i><h1 class="text-xl font-bold">Padrinos Misioneros</h1></div>
                <div class="flex items-center space-x-4"><span id="userEmail" class="text-sm hidden sm:block"></span><button id="logoutBtn" class="bg-white text-blue-600 px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-50 transition-colors duration-300">Cerrar Sesión</button></div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-blue-100 p-3 mr-4"><i class="fas fa-users text-blue-600 text-xl"></i></div>
                    <div><p class="text-gray-500 text-sm">Total Padrinos</p><h3 id="totalSponsors" class="text-2xl font-bold text-gray-800">0</h3></div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-green-100 p-3 mr-4"><i class="fas fa-check-circle text-green-600 text-xl"></i></div>
                    <div><p class="text-gray-500 text-sm">Visitados</p><h3 id="visitedSponsors" class="text-2xl font-bold text-gray-800">0</h3></div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-red-100 p-3 mr-4"><i class="fas fa-clock text-red-600 text-xl"></i></div>
                    <div><p class="text-gray-500 text-sm">Pendientes</p><h3 id="pendingSponsors" class="text-2xl font-bold text-gray-800">0</h3></div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Gestión de Padrinos</h2>
                <div class="flex space-x-3">
                    <input type="file" id="csvFileInput" class="file-input" accept=".csv,.json" />
                    <button id="importBtn" class="bg-green-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-green-700 transition-colors duration-300 flex items-center">
                        <i class="fas fa-file-import mr-2"></i> Importar
                    </button>
                    <button id="addSponsorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-700 transition-colors duration-300 flex items-center"><i class="fas fa-plus-circle mr-2"></i> Nuevo Padrino</button>
                </div>
            </div>

            <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Importar Padrinos</h2>
                        <button id="closeImportModalBtn" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="text-sm text-gray-600">
                            <p class="mb-2">Formato CSV esperado:</p>
                            <code class="block bg-gray-100 p-2 rounded text-xs">
                                numpad,tratamiento,nombre,direccion,telefono,correo,sector,importe,notas
                            </code>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Seleccionar archivo CSV o JSON
                            </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600 mb-2">Arrastra un archivo aquí o haz clic para seleccionar</p>
                                <button type="button" id="selectFileBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    Seleccionar Archivo
                                </button>
                                <p id="selectedFileName" class="text-sm text-gray-500 mt-2 hidden"></p>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button id="cancelImportBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl">Cancelar</button>
                            <button id="processImportBtn" class="bg-green-600 text-white px-4 py-2 rounded-xl flex items-center" disabled>
                                <span id="importText">Importar</span>
                                <div id="importSpinner" class="spinner hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar padrinos</label>
                        <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div><input type="text" id="searchInput" placeholder="Buscar por nombre, dirección, No. Padrino..." class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"></div>
                    </div>
                    <div>
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por estado</label>
                        <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"><option value="all">Todos</option><option value="visited">Visitados</option><option value="pending">Pendientes</option></select>
                    </div>
                    <div>
                        <label for="sectorFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por sector</label>
                        <select id="sectorFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"><option value="all">Todos los sectores</option></select>
                    </div>
                </div>
            </div>

            <div id="sponsorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
            
            <div id="emptyState" class="hidden text-center py-12">
                <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-6"><i class="fas fa-users text-gray-400 text-3xl"></i></div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay padrinos registrados</h3>
                <p class="text-gray-500 mb-6">Comienza agregando tu primer padrino</p>
                <button id="addFirstSponsorBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-colors duration-300"><i class="fas fa-plus-circle mr-2"></i> Agregar primer padrino</button>
            </div>
        </main>

        <div id="sponsorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl my-auto">
                <div class="flex justify-between items-center mb-4 pb-2 border-b"><h2 id="modalTitle" class="text-xl font-bold text-gray-800">Añadir Nuevo Padrino</h2><button id="closeModalBtn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <form id="sponsorForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="numpad" class="block text-sm font-medium text-gray-700 mb-1">No. Padrino</label>
                            <input type="text" id="numpad" name="numpad" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: 37144110">
                        </div>
                        <div class="sm:col-span-2">
                             <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                             <input type="text" id="nombre" name="nombre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nombre completo del padrino">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="tratamiento" class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label>
                            <select id="tratamiento" name="tratamiento" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">(Ninguno)</option>
                                <option value="SR">Sr.</option>
                                <option value="SRA">Sra.</option>
                                <option value="SRITA">Srita.</option>
                                <option value="JOVEN">Joven</option>
                                <option value="SRS">Srs.</option>
                                <option value="BH">BH</option>
                                <option value="QEPD">QEPD</option>
                            </select>
                        </div>
                        <div>
                            <label for="importe" class="block text-sm font-medium text-gray-700 mb-1">Importe</label>
                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</div><input type="number" id="importe" name="importe" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg" placeholder="50.00" step="0.01"></div>
                        </div>
                         <div>
                            <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <input type="text" id="telefono" name="telefono" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Número de teléfono">
                        </div>
                    </div>
                    <div><label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label><input type="text" id="direccion" name="direccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Calle, Número, etc."></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Sector (Colonia)</label><input type="text" id="sector" name="sector" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Sector o zona"></div>
                        <div><label for="correo" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label><input type="email" id="correo" name="correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="correo@ejemplo.com"></div>
                    </div>
                    <div><label for="notas" class="block text-sm font-medium text-gray-700 mb-1">Notas</label><textarea id="notas" name="notas" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Agrega cualquier nota importante aquí..."></textarea></div>
                    <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl">Cancelar</button><button type="submit" id="saveSponsorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center"><span id="saveText">Guardar</span><div id="saveSpinner" class="spinner hidden ml-2"></div></button></div>
                </form>
            </div>
        </div>

        <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center">
                <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">¿Estás seguro?</h3><p class="text-gray-600 mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex justify-center space-x-4"><button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-xl">Cancelar</button><button id="confirmDeleteBtn" class="bg-red-600 text-white px-6 py-2 rounded-xl">Eliminar</button></div>
            </div>
        </div>
        
        <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
                <div class="flex justify-between items-center mb-4 pb-2 border-b"><h2 class="text-xl font-bold text-gray-800">Código QR del Padrino</h2><button id="closeQrModalBtn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <div id="qrcode" class="mb-4"></div><p class="text-sm text-gray-600">Escanea este código para ver los datos del padrino.</p>
            </div>
        </div>
        
        <div id="qrViewScreen" class="hidden login-container gradient-bg p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div class="mb-6"><h2 id="qrViewTitle" class="text-3xl font-bold text-gray-800"></h2><p id="qrViewSubtitle" class="text-gray-600 mt-2"></p></div>
                <div id="qrViewData" class="text-left space-y-4 text-gray-700">
                    <p><i class="fas fa-map-marker-alt text-blue-500 mr-2"></i> <span id="qrViewDireccion"></span></p>
                    <p><i class="fas fa-phone text-blue-500 mr-2"></i> <span id="qrViewTelefono"></span></p>
                    <p><i class="fas fa-tag text-blue-500 mr-2"></i> <span id="qrViewSector"></span></p>
                    <p id="qrViewNotas" class="text-sm text-gray-500 mt-4"></p>
                </div>
                <div class="mt-8">
                    <button id="markVisitedBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold shadow-md"><span id="visitedText"><i class="fas fa-check-circle mr-2"></i> Marcar como Visitado</span><div id="visitedSpinner" class="spinner hidden ml-2"></div></button>
                    <p id="qrViewStatus" class="mt-4 text-lg font-bold text-gray-500"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCO3FRhSwH1xLABwVGFSd_YYrbFp0lQEv8",
            authDomain: "pagelalo-1b210.firebaseapp.com",
            databaseURL: "https://pagelalo-1b210-default-rtdb.firebaseio.com",
            projectId: "pagelalo-1b210",
            storageBucket: "pagelalo-1b210.firebasestorage.app",
            messagingSenderId: "1096735980204",
            appId: "1:1096735980204:web:8252ddb9fb484c398dfd09"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
    
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginError = document.getElementById('loginError');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const sponsorList = document.getElementById('sponsorList');
        const emptyState = document.getElementById('emptyState');
        const addSponsorBtn = document.getElementById('addSponsorBtn');
        const addFirstSponsorBtn = document.getElementById('addFirstSponsorBtn');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const sectorFilter = document.getElementById('sectorFilter');
        const sponsorModal = document.getElementById('sponsorModal');
        const modalTitle = document.getElementById('modalTitle');
        const sponsorForm = document.getElementById('sponsorForm');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveSponsorBtn = document.getElementById('saveSponsorBtn');
        const saveText = document.getElementById('saveText');
        const saveSpinner = document.getElementById('saveSpinner');
        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const totalSponsors = document.getElementById('totalSponsors');
        const visitedSponsors = document.getElementById('visitedSponsors');
        const pendingSponsors = document.getElementById('pendingSponsors');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');
        const qrModal = document.getElementById('qrModal');
        const qrcodeContainer = document.getElementById('qrcode');
        const closeQrModalBtn = document.getElementById('closeQrModalBtn');
        const qrViewScreen = document.getElementById('qrViewScreen');
        const qrViewTitle = document.getElementById('qrViewTitle');
        const qrViewDireccion = document.getElementById('qrViewDireccion');
        const qrViewTelefono = document.getElementById('qrViewTelefono');
        const qrViewSector = document.getElementById('qrViewSector');
        const qrViewNotas = document.getElementById('qrViewNotas');
        const markVisitedBtn = document.getElementById('markVisitedBtn');
        const visitedText = document.getElementById('visitedText');
        const visitedSpinner = document.getElementById('visitedSpinner');
        const qrViewStatus = document.getElementById('qrViewStatus');

        // Import elements
        const importBtn = document.getElementById('importBtn');
        const importModal = document.getElementById('importModal');
        const closeImportModalBtn = document.getElementById('closeImportModalBtn');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const csvFileInput = document.getElementById('csvFileInput');
        const selectedFileName = document.getElementById('selectedFileName');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const processImportBtn = document.getElementById('processImportBtn');
        const importText = document.getElementById('importText');
        const importSpinner = document.getElementById('importSpinner');

        // State variables
        let editMode = false;
        let currentSponsorId = null;
        let userId = null;
        let sponsorToDeleteId = null;
        let sponsors = [];
        let filteredSponsors = [];
        let sectors = new Set();
        let selectedFile = null;

        const showToast = (message, type = 'success') => {
            toast.className = `toast ${type} show`;
            toastIcon.className = type === 'success' ? 'fas fa-check-circle mr-2' : 'fas fa-exclamation-circle mr-2';
            toastMessage.textContent = message;
            setTimeout(() => { toast.className = 'toast hidden'; }, 3000);
        };

        const checkAdminStatus = async (userId) => {
            try {
                return new Promise((resolve) => {
                    database.ref('admins').once('value', (snapshot) => {
                        const admins = snapshot.val();
                        const isAdmin = admins && admins[userId] === true;
                        resolve(isAdmin);
                    }, (error) => {
                        console.error("Error checking admin status:", error);
                        showToast('Error al verificar permisos', 'error');
                        resolve(false);
                    });
                });
            } catch (error) {
                console.error("Error checking admin status:", error);
                showToast('Error al verificar permisos de administrador', 'error');
                return false;
            }
        };

        // CSV parsing function
        const parseCSV = (text) => {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.some(v => v)) { // Skip empty lines
                    const obj = {};
                    headers.forEach((header, index) => {
                        const value = values[index] || '';
                        if (value) {
                            obj[header] = value;
                        }
                    });
                    data.push(obj);
                }
            }
            return data;
        };

        // Import sponsors function with better error handling
        const importSponsors = async (data) => {
            let successCount = 0;
            let errorCount = 0;
            const batch = {};
            
            console.log('Starting import of', data.length, 'sponsors');
            
            for (const item of data) {
                try {
                    // Create a unique key for each sponsor
                    const key = database.ref(`users/${userId}/padrinos`).push().key;
                    
                    const sponsorData = {
                        numpad: item.numpad || item['no. padrino'] || item.numero || null,
                        tratamiento: item.tratamiento || item.treatment || null,
                        nombre: item.nombre || item.name || item.fullname || null,
                        direccion: item.direccion || item.address || item.direction || null,
                        telefono: item.telefono || item.phone || item.telephone || null,
                        correo: item.correo || item.email || item.mail || null,
                        sector: item.sector || item.zone || item.colonia || null,
                        importe: item.importe ? parseFloat(item.importe) : null,
                        notas: item.notas || item.notes || item.comments || null,
                        visitadoEn: null // All imported sponsors start as unvisited
                    };
                    
                    // Remove null values
                    Object.keys(sponsorData).forEach(key => {
                        if (sponsorData[key] === null || sponsorData[key] === '') {
                            delete sponsorData[key];
                        }
                    });
                    
                    // Only add if we have at least a name or numpad
                    if (sponsorData.nombre || sponsorData.numpad) {
                        batch[`users/${userId}/padrinos/${key}`] = sponsorData;
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Error processing sponsor:', error);
                    errorCount++;
                }
            }
            
            console.log('Prepared batch with', Object.keys(batch).length, 'sponsors');
            
            // Save all sponsors in batch
            if (Object.keys(batch).length > 0) {
                try {
                    await database.ref().update(batch);
                    showToast(`Importación completada: ${successCount} padrinos importados${errorCount > 0 ? `, ${errorCount} errores` : ''}`, 'success');
                } catch (error) {
                    console.error('Error saving batch:', error);
                    showToast('Error al guardar los datos importados', 'error');
                }
            } else {
                showToast('No se encontraron datos válidos para importar', 'error');
            }
            
            return { successCount, errorCount };
        };

        const formatVisitDate = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
            return `Visitado el ${date.toLocaleDateString('es-ES', options)}`;
        };

        const createQrUrl = (sponsorId) => {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?mode=qr&id=${sponsorId}`;
        };

        const renderQrModal = (sponsorId) => {
            const qrUrl = createQrUrl(sponsorId);
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, { text: qrUrl, width: 256, height: 256 });
            qrModal.classList.remove('hidden');
        };

        const renderQrView = async (sponsorId) => {
            const userRef = database.ref(`users/${userId}/padrinos/${sponsorId}`);
            const snapshot = await userRef.once('value');
            if (!snapshot.exists()) {
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                showToast('QR inválido o padrino no encontrado', 'error');
                return;
            }
            const sponsor = snapshot.val();
            qrViewScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginScreen.classList.add('hidden');
            qrViewTitle.textContent = `${sponsor.tratamiento || ''} ${sponsor.nombre || 'Padrino'}`.trim();
            qrViewDireccion.textContent = sponsor.direccion || 'No especificado';
            qrViewTelefono.textContent = sponsor.telefono || 'No especificado';
            qrViewSector.textContent = sponsor.sector || 'No especificado';
            qrViewNotas.textContent = sponsor.notas || 'No hay notas.';
            if (sponsor.visitadoEn) {
                qrViewStatus.textContent = `Estado: Visitado`;
                markVisitedBtn.classList.add('hidden');
            } else {
                qrViewStatus.textContent = `Estado: Pendiente`;
                markVisitedBtn.classList.remove('hidden');
            }
            markVisitedBtn.onclick = async () => {
                visitedText.textContent = 'Actualizando...';
                visitedSpinner.classList.remove('hidden');
                markVisitedBtn.disabled = true;
                try {
                    await userRef.update({ visitadoEn: Date.now() });
                    showToast('Padrino marcado como visitado', 'success');
                    qrViewStatus.textContent = `Estado: Visitado`;
                    markVisitedBtn.classList.add('hidden');
                } catch (e) {
                    showToast('Error al actualizar el estado', 'error');
                } finally {
                    visitedText.textContent = 'Marcar como Visitado';
                    visitedSpinner.classList.add('hidden');
                    markVisitedBtn.disabled = false;
                }
            };
        };

        const createMainSponsorCard = (sponsor) => {
            const isVisited = !!sponsor.visitadoEn;
            const visitDateText = isVisited ? formatVisitDate(sponsor.visitadoEn) : '';
            const fullName = `${sponsor.tratamiento || ''} ${sponsor.nombre || 'Sin nombre'}`.trim();
            const formattedImporte = sponsor.importe ? `${Number(sponsor.importe).toFixed(2)}` : '';

            return `
                <div class="bg-white rounded-2xl shadow-md p-5 card-hover">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${fullName}</h3>
                            ${sponsor.numpad ? `<p class="text-xs text-gray-500">No. Padrino: ${sponsor.numpad}</p>` : ''}
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" data-id="${sponsor.id}" class="sr-only peer toggle-visited-btn" ${isVisited ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="space-y-2 mb-4 border-t pt-3">
                        ${sponsor.direccion ? `<div class="flex items-start text-gray-600"><i class="fas fa-map-marker-alt mr-3 mt-1 w-4 text-center"></i><span class="text-sm">${sponsor.direccion}</span></div>` : ''}
                        ${sponsor.telefono ? `<div class="flex items-center text-gray-600"><i class="fas fa-phone mr-3 w-4 text-center"></i><span class="text-sm">${sponsor.telefono}</span></div>` : ''}
                        ${sponsor.sector ? `<div class="flex items-center text-gray-600"><i class="fas fa-tag mr-3 w-4 text-center"></i><span class="text-sm">${sponsor.sector}</span></div>` : ''}
                    </div>
                    
                    ${visitDateText ? `<div class="text-xs text-gray-500 mb-2">${visitDateText}</div>` : ''}

                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="text-lg font-bold text-blue-600">${formattedImporte}</span>
                        <div class="flex items-center space-x-3">
                            <button class="qr-btn text-purple-500 hover:text-purple-700" data-id="${sponsor.id}"><i class="fas fa-qrcode fa-lg"></i></button>
                            <button class="edit-btn text-blue-500 hover:text-blue-700" data-id="${sponsor.id}"><i class="fas fa-edit fa-lg"></i></button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${sponsor.id}"><i class="fas fa-trash-alt fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const updateSectorsList = () => {
            sectors.clear();
            sponsors.forEach(sponsor => {
                if (sponsor.sector) sectors.add(sponsor.sector);
            });
            sectorFilter.innerHTML = '<option value="all">Todos los sectores</option>';
            [...sectors].sort().forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });
        };

        const filterSponsors = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const sectorValue = sectorFilter.value;
            filteredSponsors = sponsors.filter(sponsor => {
                const matchesSearch = searchTerm === '' || 
                                    (sponsor.nombre && sponsor.nombre.toLowerCase().includes(searchTerm)) || 
                                    (sponsor.numpad && sponsor.numpad.toLowerCase().includes(searchTerm)) ||
                                    (sponsor.direccion && sponsor.direccion.toLowerCase().includes(searchTerm));
                const matchesStatus = statusValue === 'all' || (statusValue === 'visited' && sponsor.visitadoEn) || (statusValue === 'pending' && !sponsor.visitadoEn);
                const matchesSector = sectorValue === 'all' || (sponsor.sector && sponsor.sector === sectorValue);
                return matchesSearch && matchesStatus && matchesSector;
            });
            renderMainList(filteredSponsors);
        };

        const renderMainList = (sponsorsData) => {
            console.log('Rendering list with', sponsorsData.length, 'sponsors');
            totalSponsors.textContent = sponsors.length;
            const visitedCount = sponsors.filter(s => s.visitadoEn).length;
            visitedSponsors.textContent = visitedCount;
            pendingSponsors.textContent = sponsors.length - visitedCount;
            
            if (sponsorsData.length === 0) {
                sponsorList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            sponsorList.classList.remove('hidden');
            emptyState.classList.add('hidden');
            sponsorsData.sort((a, b) => {
                const aVisited = !!a.visitadoEn;
                const bVisited = !!b.visitadoEn;
                if (aVisited && !bVisited) return 1;
                if (!aVisited && bVisited) return -1;
                return (a.nombre || '').localeCompare(b.nombre || '');
            });
            sponsorList.innerHTML = sponsorsData.map(sponsor => createMainSponsorCard(sponsor)).join('');
        };

        const openModal = (sponsor = null) => {
            sponsorModal.classList.remove('hidden');
            if (sponsor) {
                document.getElementById('numpad').value = sponsor.numpad || '';
                document.getElementById('tratamiento').value = sponsor.tratamiento || '';
                document.getElementById('nombre').value = sponsor.nombre || '';
                document.getElementById('direccion').value = sponsor.direccion || '';
                document.getElementById('telefono').value = sponsor.telefono || '';
                document.getElementById('correo').value = sponsor.correo || '';
                document.getElementById('sector').value = sponsor.sector || '';
                document.getElementById('importe').value = sponsor.importe || '';
                document.getElementById('notas').value = sponsor.notas || '';
                currentSponsorId = sponsor.id;
                editMode = true;
                modalTitle.textContent = 'Editar Padrino';
                saveText.textContent = 'Guardar Cambios';
            } else {
                sponsorForm.reset();
                currentSponsorId = null;
                editMode = false;
                modalTitle.textContent = 'Añadir Nuevo Padrino';
                saveText.textContent = 'Guardar';
            }
        };

        const closeModal = () => {
            sponsorModal.classList.add('hidden');
            sponsorForm.reset();
            editMode = false;
            currentSponsorId = null;
        };

        // Import event listeners
        importBtn.addEventListener('click', () => {
            importModal.classList.remove('hidden');
        });

        selectFileBtn.addEventListener('click', () => {
            csvFileInput.click();
        });

        csvFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                selectedFileName.textContent = file.name;
                selectedFileName.classList.remove('hidden');
                processImportBtn.disabled = false;
            }
        });

        closeImportModalBtn.addEventListener('click', () => {
            importModal.classList.add('hidden');
            selectedFile = null;
            selectedFileName.classList.add('hidden');
            processImportBtn.disabled = true;
            csvFileInput.value = '';
        });

        cancelImportBtn.addEventListener('click', () => {
            importModal.classList.add('hidden');
            selectedFile = null;
            selectedFileName.classList.add('hidden');
            processImportBtn.disabled = true;
            csvFileInput.value = '';
        });

        processImportBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            importText.textContent = 'Procesando...';
            importSpinner.classList.remove('hidden');
            processImportBtn.disabled = true;
            
            try {
                const fileText = await selectedFile.text();
                let data;
                
                if (selectedFile.name.endsWith('.json')) {
                    try {
                        data = JSON.parse(fileText);
                        if (!Array.isArray(data)) {
                            throw new Error('El archivo JSON debe contener un array de objetos');
                        }
                    } catch (e) {
                        throw new Error('Error parsing JSON: ' + e.message);
                    }
                } else {
                    data = parseCSV(fileText);
                }
                
                console.log('Parsed data:', data);
                
                if (data.length === 0) {
                    throw new Error('No se encontraron datos válidos en el archivo');
                }
                
                await importSponsors(data);
                
                // Close modal after successful import
                importModal.classList.add('hidden');
                selectedFile = null;
                selectedFileName.classList.add('hidden');
                csvFileInput.value = '';
                
            } catch (error) {
                console.error('Import error:', error);
                showToast('Error en la importación: ' + error.message, 'error');
            } finally {
                importText.textContent = 'Importar';
                importSpinner.classList.add('hidden');
                processImportBtn.disabled = true;
            }
        });

        // Login form
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginText.textContent = "Iniciando...";
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            loginBtn.disabled = true;
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const isAdmin = await checkAdminStatus(userCredential.user.uid);
                if (!isAdmin) {
                    await auth.signOut();
                    throw new Error("No tienes permisos de administrador.");
                }
                showToast('Sesión iniciada correctamente');
            } catch (error) {
                let msg = error.message || "Error al iniciar sesión.";
                if (error.code === 'auth/user-not-found') msg = "Usuario no encontrado";
                if (error.code === 'auth/wrong-password') msg = "Contraseña incorrecta";
                loginError.textContent = msg;
                loginError.classList.remove('hidden');
            } finally {
                loginText.textContent = "Iniciar Sesión";
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try { await auth.signOut(); showToast('Sesión cerrada'); } 
            catch (error) { showToast('Error al cerrar sesión', 'error'); }
        });

        addSponsorBtn.addEventListener('click', () => openModal());
        addFirstSponsorBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        closeQrModalBtn.addEventListener('click', () => qrModal.classList.add('hidden'));
        searchInput.addEventListener('input', filterSponsors);
        statusFilter.addEventListener('change', filterSponsors);
        sectorFilter.addEventListener('change', filterSponsors);

        sponsorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveText.textContent = "Guardando...";
            saveSpinner.classList.remove('hidden');
            saveSponsorBtn.disabled = true;
            
            const sponsorData = {
                numpad: document.getElementById('numpad').value.trim() || null,
                tratamiento: document.getElementById('tratamiento').value.trim() || null,
                nombre: document.getElementById('nombre').value.trim() || null,
                direccion: document.getElementById('direccion').value.trim() || null,
                telefono: document.getElementById('telefono').value.trim() || null,
                correo: document.getElementById('correo').value.trim() || null,
                sector: document.getElementById('sector').value.trim() || null,
                importe: parseFloat(document.getElementById('importe').value) || null,
                notas: document.getElementById('notas').value.trim() || null,
            };
            
            Object.keys(sponsorData).forEach(key => (sponsorData[key] === null || sponsorData[key] === '') && delete sponsorData[key]);
            
            try {
                if (editMode) {
                    await database.ref(`users/${userId}/padrinos/${currentSponsorId}`).update(sponsorData);
                    showToast('Padrino actualizado');
                } else {
                    await database.ref(`users/${userId}/padrinos`).push().set({ ...sponsorData, visitadoEn: null });
                    showToast('Padrino agregado');
                }
                closeModal();
            } catch (e) {
                showToast('Error al guardar', 'error');
            } finally {
                saveText.textContent = "Guardar";
                saveSpinner.classList.add('hidden');
                saveSponsorBtn.disabled = false;
            }
        });

        auth.onAuthStateChanged(async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'qr' && urlParams.get('id')) {
                userId = urlParams.get('uid');
                renderQrView(urlParams.get('id'));
            } else if (user) {
                userId = user.uid;
                userEmail.textContent = user.email;
                const isAdmin = await checkAdminStatus(userId);
                if (!isAdmin) {
                    await auth.signOut();
                    loginError.textContent = "No tienes permisos para acceder.";
                    loginError.classList.remove('hidden');
                    return;
                }
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // Listen to Firebase changes with better error handling
                database.ref(`users/${userId}/padrinos`).on('value', (snapshot) => {
                    console.log('Firebase data updated');
                    const sponsorsData = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            sponsorsData.push({ id: child.key, ...child.val() });
                        });
                    }
                    console.log('Loaded', sponsorsData.length, 'sponsors from Firebase');
                    sponsors = sponsorsData;
                    updateSectorsList();
                    filterSponsors();
                }, (error) => {
                    console.error('Firebase error:', error);
                    showToast('Error al cargar datos', 'error');
                });

                sponsorList.addEventListener('click', async (e) => {
                    const button = e.target.closest('button, input');
                    if (!button) return;

                    const id = button.dataset.id;
                    if (button.matches('.toggle-visited-btn')) {
                        try {
                            const ref = database.ref(`users/${userId}/padrinos/${id}`);
                            if (button.checked) {
                                await ref.update({ visitadoEn: Date.now() });
                                showToast('Marcado como visitado');
                            } else {
                                await ref.child('visitadoEn').remove();
                                showToast('Marcado como pendiente');
                            }
                        } catch (e) {
                            showToast('Error al actualizar', 'error');
                            button.checked = !button.checked; // Revert on error
                        }
                    } else if (button.matches('.edit-btn')) {
                        openModal(sponsors.find(s => s.id === id));
                    } else if (button.matches('.delete-btn')) {
                        sponsorToDeleteId = id;
                        confirmModal.classList.remove('hidden');
                    } else if (button.matches('.qr-btn')) {
                        renderQrModal(id);
                    }
                });

                confirmDeleteBtn.addEventListener('click', async () => {
                    if (sponsorToDeleteId) {
                        try {
                            await database.ref(`users/${userId}/padrinos/${sponsorToDeleteId}`).remove();
                            showToast('Padrino eliminado');
                        } catch (e) { showToast('Error al eliminar', 'error'); }
                        sponsorToDeleteId = null;
                        confirmModal.classList.add('hidden');
                    }
                });
                cancelDeleteBtn.addEventListener('click', () => {
                    sponsorToDeleteId = null;
                    confirmModal.classList.add('hidden');
                });
            } else {
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                loginForm.reset();
                if (userId) database.ref(`users/${userId}/padrinos`).off();
            }
        });
    </script>
</body>
</html>