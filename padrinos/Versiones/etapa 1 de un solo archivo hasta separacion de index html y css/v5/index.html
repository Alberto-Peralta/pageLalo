<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Padrinos Misioneros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0);
            will-change: transform, box-shadow;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .file-input {
            display: none;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin: 1px;
            background-color: #eff6ff;
            color: #2563eb;
        }

        .phone-clickable {
            cursor: pointer;
            color: #10b981;
            font-weight: 500;
            text-decoration: underline;
        }
        
        .phone-clickable:hover {
            color: #059669;
        }

        .address-clickable {
            cursor: pointer;
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .address-clickable:hover {
            color: #1d4ed8;
        }

        .notes-section {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toast" class="toast hidden"><div class="flex items-center"><i id="toast-icon" class="fas fa-info-circle mr-2"></i><span id="toast-message"></span></div></div>

    <div id="loginScreen" class="login-container gradient-bg p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-4"><i class="fas fa-hands-helping text-blue-600 text-3xl"></i></div>
                <h1 class="text-3xl font-bold text-gray-800">Padrinos Misioneros</h1>
                <p class="text-gray-600 mt-2">Inicia sesión para gestionar tus padrinos</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label><input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300" placeholder="tu@email.com"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label><input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300" placeholder="Tu contraseña"></div>
                <div id="loginError" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>
                <button type="submit" id="loginBtn" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center"><span id="loginText">Iniciar Sesión</span><div id="loginSpinner" class="spinner hidden ml-2"></div></button>
            </form>
            <p class="text-center text-gray-500 text-sm mt-6">¿Necesitas acceso? Contacta al administrador.</p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3"><i class="fas fa-hands-helping text-2xl"></i><h1 class="text-xl font-bold">Padrinos Misioneros</h1></div>
                <div class="flex items-center space-x-4"><span id="userEmail" class="text-sm hidden sm:block"></span><button id="logoutBtn" class="bg-white text-blue-600 px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-50 transition-colors duration-300">Cerrar Sesión</button></div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-blue-100 p-3 mr-4"><i class="fas fa-users text-blue-600 text-xl"></i></div>
                    <div><p class="text-gray-500 text-sm">Total Padrinos</p><h3 id="totalSponsors" class="text-2xl font-bold text-gray-800">0</h3></div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-green-100 p-3 mr-4"><i class="fas fa-check-circle text-green-600 text-xl"></i></div>
                    <div><p class="text-gray-500 text-sm">Visitados</p><h3 id="visitedSponsors" class="text-2xl font-bold text-gray-800">0</h3></div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-red-100 p-3 mr-4"><i class="fas fa-clock text-red-600 text-xl"></i></div>
                    <div><p class="text-gray-500 text-sm">Pendientes</p><h3 id="pendingSponsors" class="text-2xl font-bold text-gray-800">0</h3></div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Gestión de Padrinos</h2>
                <div class="flex space-x-3">
                    <button id="newCycleBtn" class="bg-amber-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-amber-700 transition-colors duration-300 flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Nuevo Ciclo
                    </button>
                    <button id="addSponsorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-700 transition-colors duration-300 flex items-center"><i class="fas fa-plus-circle mr-2"></i> Nuevo Padrino</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar padrinos</label>
                        <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div><input type="text" id="searchInput" placeholder="Buscar por nombre, dirección, No. Padrino..." class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"></div>
                    </div>
                    <div>
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por estado</label>
                        <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"><option value="all">Todos</option><option value="visited">Visitados</option><option value="pending">Pendientes</option></select>
                    </div>
                    <div>
                        <label for="sectorFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por sector</label>
                        <select id="sectorFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"><option value="all">Todos los sectores</option></select>
                    </div>
                    <div>
                        <label for="tagFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por etiqueta</label>
                        <select id="tagFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"><option value="all">Todas las etiquetas</option></select>
                    </div>
                </div>
            </div>

            <div id="sponsorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
            
            <div id="emptyState" class="hidden text-center py-12">
                <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-6"><i class="fas fa-users text-gray-400 text-3xl"></i></div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay padrinos registrados</h3>
                <p class="text-gray-500 mb-6">Comienza agregando tu primer padrino</p>
                <button id="addFirstSponsorBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-colors duration-300"><i class="fas fa-plus-circle mr-2"></i> Agregar primer padrino</button>
            </div>
        </main>

        <!-- Modal para agregar/editar padrino -->
        <div id="sponsorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl my-auto">
                <div class="flex justify-between items-center mb-4 pb-2 border-b"><h2 id="modalTitle" class="text-xl font-bold text-gray-800">Añadir Nuevo Padrino</h2><button id="closeModalBtn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <form id="sponsorForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="numpad" class="block text-sm font-medium text-gray-700 mb-1">No. Padrino</label>
                            <input type="text" id="numpad" name="numpad" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: 37144110">
                        </div>
                        <div class="sm:col-span-2">
                             <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                             <input type="text" id="nombre" name="nombre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nombre completo del padrino">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="tratamiento" class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label>
                            <select id="tratamiento" name="tratamiento" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">(Ninguno)</option>
                                <option value="SR">Sr.</option>
                                <option value="SRA">Sra.</option>
                                <option value="SRITA">Srita.</option>
                                <option value="JOVEN">Joven</option>
                                <option value="SRS">Srs.</option>
                                <option value="BH">BH</option>
                                <option value="QEPD">QEPD</option>
                            </select>
                        </div>
                        <div>
                            <label for="importe" class="block text-sm font-medium text-gray-700 mb-1">Importe</label>
                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">$</div><input type="number" id="importe" name="importe" class="w-full pl-7 pr-4 py-2 border border-gray-300 rounded-lg" placeholder="50.00" step="0.01"></div>
                        </div>
                         <div>
                            <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <input type="text" id="telefono" name="telefono" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Número de teléfono">
                        </div>
                    </div>
                    <div><label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label><input type="text" id="direccion" name="direccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Calle, Número, etc."></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Sector (Colonia)</label><input type="text" id="sector" name="sector" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Sector o zona"></div>
                        <div><label for="correo" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label><input type="email" id="correo" name="correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="correo@ejemplo.com"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="coordenadas" class="block text-sm font-medium text-gray-700 mb-1">Coordenadas GPS (Opcional)</label>
                            <div class="flex space-x-2">
                                <input type="text" id="coordenadas" name="coordenadas" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Lat, Lng">
                                <button type="button" id="getLocationBtn" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700" title="Obtener ubicación actual">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="etiqueta" class="block text-sm font-medium text-gray-700 mb-1">Etiqueta</label>
                            <input type="text" id="etiqueta" name="etiqueta" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Escribe una etiqueta personalizada">
                        </div>
                    </div>
                    <div><label for="notas" class="block text-sm font-medium text-gray-700 mb-1">Notas</label><textarea id="notas" name="notas" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Agrega cualquier nota importante aquí..."></textarea></div>
                    <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl">Cancelar</button><button type="submit" id="saveSponsorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center"><span id="saveText">Guardar</span><div id="saveSpinner" class="spinner hidden ml-2"></div></button></div>
                </form>
            </div>
        </div>

        <!-- Modal de confirmación de eliminación -->
        <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
                <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">¿Confirmar eliminación?</h3>
                <p class="text-gray-600 mb-4 text-center">Para eliminar este padrino, ingresa tu contraseña:</p>
                <div class="mb-4">
                    <input type="password" id="deletePassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Tu contraseña">
                </div>
                <div id="deleteError" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm mb-4">
                    Contraseña incorrecta
                </div>
                <div class="flex justify-center space-x-4">
                    <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-xl">Cancelar</button>
                    <button id="confirmDeleteBtn" class="bg-red-600 text-white px-6 py-2 rounded-xl flex items-center">
                        <span id="deleteText">Eliminar</span>
                        <div id="deleteSpinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal de nuevo ciclo -->
        <div id="newCycleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
                <div class="w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-sync-alt text-amber-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">¿Iniciar Nuevo Ciclo?</h3>
                <p class="text-gray-600 mb-6 text-center">Se desmarcaran todos los padrinos visitados para comenzar un nuevo ciclo mensual. Esta acción no se puede deshacer.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancelNewCycleBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-xl">Cancelar</button>
                    <button id="confirmNewCycleBtn" class="bg-amber-600 text-white px-6 py-2 rounded-xl flex items-center">
                        <span id="newCycleText">Iniciar Ciclo</span>
                        <div id="newCycleSpinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal de QR -->
        <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
                <div class="flex justify-between items-center mb-4 pb-2 border-b"><h2 class="text-xl font-bold text-gray-800">Código QR del Padrino</h2><button id="closeQrModalBtn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div>
                <div id="qrcode" class="mb-4"></div><p class="text-sm text-gray-600">Escanea este código para ver los datos del padrino.</p>
            </div>
        </div>
        
        <!-- Vista QR -->
        <div id="qrViewScreen" class="hidden login-container gradient-bg p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div class="mb-6"><h2 id="qrViewTitle" class="text-3xl font-bold text-gray-800"></h2><p id="qrViewSubtitle" class="text-gray-600 mt-2"></p></div>
                <div id="qrViewData" class="text-left space-y-4 text-gray-700">
                    <p><i class="fas fa-map-marker-alt text-blue-500 mr-2"></i> <span id="qrViewDireccion"></span></p>
                    <p><i class="fas fa-phone text-blue-500 mr-2"></i> <span id="qrViewTelefono"></span></p>
                    <p><i class="fas fa-tag text-blue-500 mr-2"></i> <span id="qrViewSector"></span></p>
                    <p id="qrViewNotas" class="text-sm text-gray-500 mt-4"></p>
                </div>
                <div class="mt-8">
                    <button id="markVisitedBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold shadow-md"><span id="visitedText"><i class="fas fa-check-circle mr-2"></i> Marcar como Visitado</span><div id="visitedSpinner" class="spinner hidden ml-2"></div></button>
                    <p id="qrViewStatus" class="mt-4 text-lg font-bold text-gray-500"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCO3FRhSwH1xLABwVGFSd_YYrbFp0lQEv8",
            authDomain: "pagelalo-1b210.firebaseapp.com",
            databaseURL: "https://pagelalo-1b210-default-rtdb.firebaseio.com",
            projectId: "pagelalo-1b210",
            storageBucket: "pagelalo-1b210.firebasestorage.app",
            messagingSenderId: "1096735980204",
            appId: "1:1096735980204:web:8252ddb9fb484c398dfd09"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
    
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginError = document.getElementById('loginError');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const sponsorList = document.getElementById('sponsorList');
        const emptyState = document.getElementById('emptyState');
        const addSponsorBtn = document.getElementById('addSponsorBtn');
        const addFirstSponsorBtn = document.getElementById('addFirstSponsorBtn');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const sectorFilter = document.getElementById('sectorFilter');
        const tagFilter = document.getElementById('tagFilter');
        const sponsorModal = document.getElementById('sponsorModal');
        const modalTitle = document.getElementById('modalTitle');
        const sponsorForm = document.getElementById('sponsorForm');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveSponsorBtn = document.getElementById('saveSponsorBtn');
        const saveText = document.getElementById('saveText');
        const saveSpinner = document.getElementById('saveSpinner');
        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const totalSponsors = document.getElementById('totalSponsors');
        const visitedSponsors = document.getElementById('visitedSponsors');
        const pendingSponsors = document.getElementById('pendingSponsors');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');
        const qrModal = document.getElementById('qrModal');
        const qrcodeContainer = document.getElementById('qrcode');
        const closeQrModalBtn = document.getElementById('closeQrModalBtn');
        const qrViewScreen = document.getElementById('qrViewScreen');
        const qrViewTitle = document.getElementById('qrViewTitle');
        const qrViewDireccion = document.getElementById('qrViewDireccion');
        const qrViewTelefono = document.getElementById('qrViewTelefono');
        const qrViewSector = document.getElementById('qrViewSector');
        const qrViewNotas = document.getElementById('qrViewNotas');
        const markVisitedBtn = document.getElementById('markVisitedBtn');
        const visitedText = document.getElementById('visitedText');
        const visitedSpinner = document.getElementById('visitedSpinner');
        const qrViewStatus = document.getElementById('qrViewStatus');
        const deletePassword = document.getElementById('deletePassword');
        const deleteError = document.getElementById('deleteError');
        const deleteText = document.getElementById('deleteText');
        const deleteSpinner = document.getElementById('deleteSpinner');
        
        // New Cycle Modal elements
        const newCycleBtn = document.getElementById('newCycleBtn');
        const newCycleModal = document.getElementById('newCycleModal');
        const confirmNewCycleBtn = document.getElementById('confirmNewCycleBtn');
        const cancelNewCycleBtn = document.getElementById('cancelNewCycleBtn');
        const newCycleText = document.getElementById('newCycleText');
        const newCycleSpinner = document.getElementById('newCycleSpinner');
        
        // New elements for enhanced functionality
        const getLocationBtn = document.getElementById('getLocationBtn');

        // State variables
        let editMode = false;
        let currentSponsorId = null;
        let userId = null;
        let sponsorToDeleteId = null;
        let sponsors = [];
        let filteredSponsors = [];
        let sectors = new Set();
        let tags = new Set();

        const showToast = (message, type = 'success') => {
            toast.className = `toast ${type} show`;
            toastIcon.className = type === 'success' ? 'fas fa-check-circle mr-2' : 'fas fa-exclamation-circle mr-2';
            toastMessage.textContent = message;
            setTimeout(() => { toast.className = 'toast hidden'; }, 3000);
        };

        // Function to validate password with Firebase Auth
        const validatePassword = async (password) => {
            try {
                const user = auth.currentUser;
                if (!user) return false;
                
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                await user.reauthenticateWithCredential(credential);
                return true;
            } catch (error) {
                console.log('Password validation failed:', error.code);
                return false;
            }
        };

        // Phone and WhatsApp functionality
        const formatPhoneNumber = (phone) => {
            if (!phone) return '';
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 10) {
                return `52${cleaned}`;
            }
            return cleaned;
        };

        const makeCall = (phone) => {
            const formatted = formatPhoneNumber(phone);
            if (formatted) {
                window.open(`tel:+${formatted}`, '_self');
            }
        };

        const sendWhatsApp = (phone, name) => {
            const formatted = formatPhoneNumber(phone);
            if (formatted) {
                const message = encodeURIComponent(`Hola ${name || 'Padrino'}, espero se encuentre bien.`);
                window.open(`https://wa.me/${formatted}?text=${message}`, '_blank');
            }
        };

        const showPhoneActions = (phone, name, event) => {
            event.preventDefault();
            if (!phone) return;

            const actionMenu = document.createElement('div');
            actionMenu.className = 'fixed bg-white shadow-lg rounded-lg p-2 z-50 border';
            actionMenu.style.left = event.pageX + 'px';
            actionMenu.style.top = event.pageY + 'px';
            
            actionMenu.innerHTML = `
                <button class="block w-full text-left px-3 py-2 hover:bg-gray-100 rounded" onclick="makeCall('${phone}')">
                    <i class="fas fa-phone text-green-600 mr-2"></i> Llamar
                </button>
                <button class="block w-full text-left px-3 py-2 hover:bg-gray-100 rounded" onclick="sendWhatsApp('${phone}', '${name}')">
                    <i class="fab fa-whatsapp text-green-600 mr-2"></i> WhatsApp
                </button>
            `;
            
            document.body.appendChild(actionMenu);
            
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!actionMenu.contains(e.target)) {
                        document.body.removeChild(actionMenu);
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 100);
        };

        // Google Maps integration
        const openGoogleMaps = (address, coordinates) => {
            let url = 'https://www.google.com/maps/search/';
            if (coordinates && coordinates.includes(',')) {
                const [lat, lng] = coordinates.split(',').map(coord => coord.trim());
                if (lat && lng) {
                    url += `${lat},${lng}`;
                } else if (address) {
                    url += encodeURIComponent(address);
                }
            } else if (address) {
                url += encodeURIComponent(address);
            }
            window.open(url, '_blank');
        };

        // Get current location
        const getCurrentLocation = () => {
            if (!navigator.geolocation) {
                showToast('Geolocalización no disponible en este navegador', 'error');
                return;
            }

            getLocationBtn.disabled = true;
            getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    document.getElementById('coordenadas').value = `${lat}, ${lng}`;
                    showToast('Ubicación obtenida correctamente');
                    getLocationBtn.disabled = false;
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                },
                (error) => {
                    showToast('Error al obtener ubicación: ' + error.message, 'error');
                    getLocationBtn.disabled = false;
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                }
            );
        };

        const checkAdminStatus = async (userId) => {
            try {
                return new Promise((resolve) => {
                    database.ref('admins').once('value', (snapshot) => {
                        const admins = snapshot.val();
                        const isAdmin = admins && admins[userId] === true;
                        resolve(isAdmin);
                    }, (error) => {
                        console.error("Error checking admin status:", error);
                        showToast('Error al verificar permisos', 'error');
                        resolve(false);
                    });
                });
            } catch (error) {
                console.error("Error checking admin status:", error);
                showToast('Error al verificar permisos de administrador', 'error');
                return false;
            }
        };

        const formatVisitDate = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
            return `Visitado el ${date.toLocaleDateString('es-ES', options)}`;
        };

        const createQrUrl = (sponsorId) => {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?mode=qr&id=${sponsorId}&uid=${userId}`;
        };

        const renderQrModal = (sponsorId) => {
            const qrUrl = createQrUrl(sponsorId);
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, { text: qrUrl, width: 256, height: 256 });
            qrModal.classList.remove('hidden');
        };

        const renderQrView = async (sponsorId) => {
            const userRef = database.ref(`users/${userId}/padrinos/${sponsorId}`);
            const snapshot = await userRef.once('value');
            if (!snapshot.exists()) {
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                showToast('QR inválido o padrino no encontrado', 'error');
                return;
            }
            const sponsor = snapshot.val();
            qrViewScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginScreen.classList.add('hidden');
            qrViewTitle.textContent = `${sponsor.tratamiento || ''} ${sponsor.nombre || 'Padrino'}`.trim();
            qrViewDireccion.textContent = sponsor.direccion || 'No especificado';
            qrViewTelefono.textContent = sponsor.telefono || 'No especificado';
            qrViewSector.textContent = sponsor.sector || 'No especificado';
            qrViewNotas.textContent = sponsor.notas || 'No hay notas.';
            if (sponsor.visitadoEn) {
                qrViewStatus.textContent = `Estado: Visitado`;
                markVisitedBtn.classList.add('hidden');
            } else {
                qrViewStatus.textContent = `Estado: Pendiente`;
                markVisitedBtn.classList.remove('hidden');
            }
            markVisitedBtn.onclick = async () => {
                visitedText.textContent = 'Actualizando...';
                visitedSpinner.classList.remove('hidden');
                markVisitedBtn.disabled = true;
                try {
                    await userRef.update({ visitadoEn: Date.now() });
                    showToast('Padrino marcado como visitado', 'success');
                    qrViewStatus.textContent = `Estado: Visitado`;
                    markVisitedBtn.classList.add('hidden');
                } catch (e) {
                    showToast('Error al actualizar el estado', 'error');
                } finally {
                    visitedText.textContent = 'Marcar como Visitado';
                    visitedSpinner.classList.add('hidden');
                    markVisitedBtn.disabled = false;
                }
            };
        };

        const createMainSponsorCard = (sponsor) => {
            const isVisited = !!sponsor.visitadoEn;
            const visitDateText = isVisited ? formatVisitDate(sponsor.visitadoEn) : '';
            const fullName = `${sponsor.tratamiento || ''} ${sponsor.nombre || 'Sin nombre'}`.trim();
            const formattedImporte = sponsor.importe ? `${Number(sponsor.importe).toFixed(2)}` : '';
            const customTag = sponsor.etiqueta && sponsor.etiqueta.trim() ? `<span class="tag">${sponsor.etiqueta}</span>` : '';
            
            const notesSection = sponsor.notas && sponsor.notas.trim() ? `
                <div class="notes-section">
                    <div class="flex items-start">
                        <i class="fas fa-sticky-note mr-2 text-yellow-600 mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700 font-medium">Notas:</p>
                            <p class="text-sm text-gray-600 mt-1">${sponsor.notas}</p>
                        </div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="bg-white rounded-2xl shadow-md p-5 card-hover">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-lg font-bold text-gray-800">${fullName}</h3>
                                <label class="relative inline-flex items-center cursor-pointer ml-2">
                                    <input type="checkbox" data-id="${sponsor.id}" class="sr-only peer toggle-visited-btn" ${isVisited ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                ${sponsor.numpad ? `<p class="text-xs text-gray-500">No. Padrino: ${sponsor.numpad}</p>` : '<div></div>'}
                                ${customTag}
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4 border-t pt-3">
                        ${sponsor.direccion ? `
                            <div class="flex items-start text-gray-600">
                                <i class="fas fa-map-marker-alt mr-3 mt-1 w-4 text-center"></i>
                                <span class="text-sm address-clickable flex-1" onclick="openGoogleMaps('${sponsor.direccion}', '${sponsor.coordenadas || ''}')">${sponsor.direccion}</span>
                                ${sponsor.coordenadas ? '<i class="fas fa-globe text-green-500 ml-2" title="Tiene coordenadas GPS"></i>' : ''}
                            </div>
                        ` : ''}
                        ${sponsor.telefono ? `
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-phone mr-3 w-4 text-center"></i>
                                <span class="text-sm phone-clickable flex-1" onclick="showPhoneActions('${sponsor.telefono}', '${fullName}', event)">${sponsor.telefono}</span>
                                <div class="flex space-x-1 ml-2">
                                    <i class="fas fa-phone-alt text-green-500 cursor-pointer" onclick="makeCall('${sponsor.telefono}')" title="Llamar"></i>
                                    <i class="fab fa-whatsapp text-green-500 cursor-pointer" onclick="sendWhatsApp('${sponsor.telefono}', '${fullName}')" title="WhatsApp"></i>
                                </div>
                            </div>
                        ` : ''}
                        ${sponsor.sector ? `<div class="flex items-center text-gray-600"><i class="fas fa-tag mr-3 w-4 text-center"></i><span class="text-sm">${sponsor.sector}</span></div>` : ''}
                    </div>
                    
                    ${notesSection}
                    
                    ${visitDateText ? `<div class="text-xs text-gray-500 mb-2">${visitDateText}</div>` : ''}

                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="text-lg font-bold text-blue-600">${formattedImporte}</span>
                        <div class="flex items-center space-x-3">
                            <button class="qr-btn text-purple-500 hover:text-purple-700" data-id="${sponsor.id}"><i class="fas fa-qrcode fa-lg"></i></button>
                            <button class="edit-btn text-blue-500 hover:text-blue-700" data-id="${sponsor.id}"><i class="fas fa-edit fa-lg"></i></button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${sponsor.id}"><i class="fas fa-trash-alt fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const updateSectorsList = () => {
            sectors.clear();
            sponsors.forEach(sponsor => {
                if (sponsor.sector) sectors.add(sponsor.sector);
            });
            sectorFilter.innerHTML = '<option value="all">Todos los sectores</option>';
            [...sectors].sort().forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });
        };

        const updateTagsList = () => {
            tags.clear();
            sponsors.forEach(sponsor => {
                if (sponsor.etiqueta && sponsor.etiqueta.trim()) tags.add(sponsor.etiqueta.trim());
            });
            tagFilter.innerHTML = '<option value="all">Todas las etiquetas</option>';
            [...tags].sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });
        };

        const filterSponsors = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const sectorValue = sectorFilter.value;
            const tagValue = tagFilter.value;
            
            filteredSponsors = sponsors.filter(sponsor => {
                const matchesSearch = searchTerm === '' || 
                                    (sponsor.nombre && sponsor.nombre.toLowerCase().includes(searchTerm)) || 
                                    (sponsor.numpad && sponsor.numpad.toLowerCase().includes(searchTerm)) ||
                                    (sponsor.direccion && sponsor.direccion.toLowerCase().includes(searchTerm));
                const matchesStatus = statusValue === 'all' || (statusValue === 'visited' && sponsor.visitadoEn) || (statusValue === 'pending' && !sponsor.visitadoEn);
                const matchesSector = sectorValue === 'all' || (sponsor.sector && sponsor.sector === sectorValue);
                const matchesTag = tagValue === 'all' || (sponsor.etiqueta && sponsor.etiqueta === tagValue);
                return matchesSearch && matchesStatus && matchesSector && matchesTag;
            });
            renderMainList(filteredSponsors);
        };

        const renderMainList = (sponsorsData) => {
            console.log('Rendering list with', sponsorsData.length, 'sponsors');
            totalSponsors.textContent = sponsors.length;
            const visitedCount = sponsors.filter(s => s.visitadoEn).length;
            visitedSponsors.textContent = visitedCount;
            pendingSponsors.textContent = sponsors.length - visitedCount;
            
            if (sponsorsData.length === 0) {
                sponsorList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            sponsorList.classList.remove('hidden');
            emptyState.classList.add('hidden');
            sponsorsData.sort((a, b) => {
                const aVisited = !!a.visitadoEn;
                const bVisited = !!b.visitadoEn;
                if (aVisited && !bVisited) return 1;
                if (!aVisited && bVisited) return -1;
                return (a.nombre || '').localeCompare(b.nombre || '');
            });
            sponsorList.innerHTML = sponsorsData.map(sponsor => createMainSponsorCard(sponsor)).join('');
        };

        const openModal = (sponsor = null) => {
            sponsorModal.classList.remove('hidden');
            if (sponsor) {
                document.getElementById('numpad').value = sponsor.numpad || '';
                document.getElementById('tratamiento').value = sponsor.tratamiento || '';
                document.getElementById('nombre').value = sponsor.nombre || '';
                document.getElementById('direccion').value = sponsor.direccion || '';
                document.getElementById('telefono').value = sponsor.telefono || '';
                document.getElementById('correo').value = sponsor.correo || '';
                document.getElementById('sector').value = sponsor.sector || '';
                document.getElementById('importe').value = sponsor.importe || '';
                document.getElementById('notas').value = sponsor.notas || '';
                document.getElementById('coordenadas').value = sponsor.coordenadas || '';
                document.getElementById('etiqueta').value = sponsor.etiqueta || '';
                currentSponsorId = sponsor.id;
                editMode = true;
                modalTitle.textContent = 'Editar Padrino';
                saveText.textContent = 'Guardar Cambios';
            } else {
                sponsorForm.reset();
                currentSponsorId = null;
                editMode = false;
                modalTitle.textContent = 'Añadir Nuevo Padrino';
                saveText.textContent = 'Guardar';
            }
        };

        const closeModal = () => {
            sponsorModal.classList.add('hidden');
            sponsorForm.reset();
            editMode = false;
            currentSponsorId = null;
        };

        // Event listeners
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginText.textContent = "Iniciando...";
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            loginBtn.disabled = true;
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const isAdmin = await checkAdminStatus(userCredential.user.uid);
                if (!isAdmin) {
                    await auth.signOut();
                    throw new Error("No tienes permisos de administrador.");
                }
                showToast('Sesión iniciada correctamente');
            } catch (error) {
                let msg = error.message || "Error al iniciar sesión.";
                if (error.code === 'auth/user-not-found') msg = "Usuario no encontrado";
                if (error.code === 'auth/wrong-password') msg = "Contraseña incorrecta";
                loginError.textContent = msg;
                loginError.classList.remove('hidden');
            } finally {
                loginText.textContent = "Iniciar Sesión";
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try { 
                await auth.signOut(); 
                showToast('Sesión cerrada'); 
            } 
            catch (error) { showToast('Error al cerrar sesión', 'error'); }
        });

        addSponsorBtn.addEventListener('click', () => openModal());
        addFirstSponsorBtn.addEventListener('click', () => openModal());
        newCycleBtn.addEventListener('click', () => {
            const visitedCount = sponsors.filter(s => s.visitadoEn).length;
            if (visitedCount === 0) {
                showToast('No hay padrinos visitados para reiniciar', 'error');
                return;
            }
            newCycleModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        closeQrModalBtn.addEventListener('click', () => qrModal.classList.add('hidden'));
        
        // New Cycle Modal event listeners
        cancelNewCycleBtn.addEventListener('click', () => {
            newCycleModal.classList.add('hidden');
        });
        
        confirmNewCycleBtn.addEventListener('click', async () => {
            newCycleText.textContent = 'Reiniciando...';
            newCycleSpinner.classList.remove('hidden');
            confirmNewCycleBtn.disabled = true;
            
            try {
                const updates = {};
                const visitedSponsorsToReset = sponsors.filter(s => s.visitadoEn);
                
                visitedSponsorsToReset.forEach(sponsor => {
                    updates[`users/${userId}/padrinos/${sponsor.id}/visitadoEn`] = null;
                });
                
                if (Object.keys(updates).length > 0) {
                    await database.ref().update(updates);
                    showToast(`Nuevo ciclo iniciado - ${visitedSponsorsToReset.length} padrinos reiniciados`);
                }
                
                newCycleModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error resetting cycle:', error);
                showToast('Error al iniciar nuevo ciclo', 'error');
            } finally {
                newCycleText.textContent = 'Iniciar Ciclo';
                newCycleSpinner.classList.add('hidden');
                confirmNewCycleBtn.disabled = false;
            }
        });
        
        searchInput.addEventListener('input', filterSponsors);
        statusFilter.addEventListener('change', filterSponsors);
        sectorFilter.addEventListener('change', filterSponsors);
        tagFilter.addEventListener('change', filterSponsors);
        
        getLocationBtn.addEventListener('click', getCurrentLocation);

        window.makeCall = makeCall;
        window.sendWhatsApp = sendWhatsApp;
        window.showPhoneActions = showPhoneActions;
        window.openGoogleMaps = openGoogleMaps;

        sponsorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveText.textContent = "Guardando...";
            saveSpinner.classList.remove('hidden');
            saveSponsorBtn.disabled = true;
            
            const sponsorData = {
                numpad: document.getElementById('numpad').value.trim(),
                tratamiento: document.getElementById('tratamiento').value.trim(),
                nombre: document.getElementById('nombre').value.trim(),
                direccion: document.getElementById('direccion').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                correo: document.getElementById('correo').value.trim(),
                sector: document.getElementById('sector').value.trim(),
                importe: parseFloat(document.getElementById('importe').value) || 0,
                notas: document.getElementById('notas').value.trim(),
                coordenadas: document.getElementById('coordenadas').value.trim(),
                etiqueta: document.getElementById('etiqueta').value.trim(),
            };
            
            try {
                if (editMode) {
                    const updateData = {};
                    updateData.numpad = sponsorData.numpad || null;
                    updateData.tratamiento = sponsorData.tratamiento || null;
                    updateData.nombre = sponsorData.nombre || null;
                    updateData.direccion = sponsorData.direccion || null;
                    updateData.telefono = sponsorData.telefono || null;
                    updateData.correo = sponsorData.correo || null;
                    updateData.sector = sponsorData.sector || null;
                    updateData.coordenadas = sponsorData.coordenadas || null;
                    updateData.etiqueta = sponsorData.etiqueta || null;
                    updateData.notas = sponsorData.notas || null;
                    
                    if (sponsorData.importe > 0) {
                        updateData.importe = sponsorData.importe;
                    } else {
                        updateData.importe = null;
                    }
                    
                    await database.ref(`users/${userId}/padrinos/${currentSponsorId}`).update(updateData);
                    showToast('Padrino actualizado');
                } else {
                    if (!sponsorData.numpad) delete sponsorData.numpad;
                    if (!sponsorData.tratamiento) delete sponsorData.tratamiento;
                    if (!sponsorData.direccion) delete sponsorData.direccion;
                    if (!sponsorData.telefono) delete sponsorData.telefono;
                    if (!sponsorData.correo) delete sponsorData.correo;
                    if (!sponsorData.sector) delete sponsorData.sector;
                    if (!sponsorData.coordenadas) delete sponsorData.coordenadas;
                    if (!sponsorData.etiqueta) delete sponsorData.etiqueta;
                    if (!sponsorData.notas) delete sponsorData.notas;
                    if (sponsorData.importe === 0) delete sponsorData.importe;
                    
                    await database.ref(`users/${userId}/padrinos`).push().set({ ...sponsorData, visitadoEn: null });
                    showToast('Padrino agregado');
                }
                closeModal();
            } catch (e) {
                showToast('Error al guardar', 'error');
            } finally {
                saveText.textContent = "Guardar";
                saveSpinner.classList.add('hidden');
                saveSponsorBtn.disabled = false;
            }
        });

        auth.onAuthStateChanged(async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'qr' && urlParams.get('id')) {
                userId = urlParams.get('uid');
                renderQrView(urlParams.get('id'));
            } else if (user) {
                userId = user.uid;
                userEmail.textContent = user.email;
                const isAdmin = await checkAdminStatus(userId);
                if (!isAdmin) {
                    await auth.signOut();
                    loginError.textContent = "No tienes permisos para acceder.";
                    loginError.classList.remove('hidden');
                    return;
                }
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                database.ref(`users/${userId}/padrinos`).on('value', (snapshot) => {
                    console.log('Firebase data updated');
                    const sponsorsData = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            sponsorsData.push({ id: child.key, ...child.val() });
                        });
                    }
                    console.log('Loaded', sponsorsData.length, 'sponsors from Firebase');
                    sponsors = sponsorsData;
                    updateSectorsList();
                    updateTagsList();
                    filterSponsors();
                }, (error) => {
                    console.error('Firebase error:', error);
                    showToast('Error al cargar datos', 'error');
                });

                sponsorList.addEventListener('click', async (e) => {
                    const button = e.target.closest('button, input');
                    if (!button) return;

                    const id = button.dataset.id;
                    if (button.matches('.toggle-visited-btn')) {
                        try {
                            const ref = database.ref(`users/${userId}/padrinos/${id}`);
                            if (button.checked) {
                                await ref.update({ visitadoEn: Date.now() });
                                showToast('Marcado como visitado');
                            } else {
                                await ref.child('visitadoEn').remove();
                                showToast('Marcado como pendiente');
                            }
                        } catch (e) {
                            showToast('Error al actualizar', 'error');
                            button.checked = !button.checked;
                        }
                    } else if (button.matches('.edit-btn')) {
                        openModal(sponsors.find(s => s.id === id));
                    } else if (button.matches('.delete-btn')) {
                        sponsorToDeleteId = id;
                        deletePassword.value = '';
                        deleteError.classList.add('hidden');
                        confirmModal.classList.remove('hidden');
                    } else if (button.matches('.qr-btn')) {
                        renderQrModal(id);
                    }
                });

                // Delete confirmation handling
                cancelDeleteBtn.addEventListener('click', () => {
                    confirmModal.classList.add('hidden');
                    sponsorToDeleteId = null;
                });

                confirmDeleteBtn.addEventListener('click', async () => {
                    const password = deletePassword.value;
                    if (!password) {
                        deleteError.textContent = 'Por favor ingresa tu contraseña';
                        deleteError.classList.remove('hidden');
                        return;
                    }

                    deleteText.textContent = 'Verificando...';
                    deleteSpinner.classList.remove('hidden');
                    confirmDeleteBtn.disabled = true;

                    try {
                        const isValid = await validatePassword(password);
                        if (!isValid) {
                            deleteError.textContent = 'Contraseña incorrecta';
                            deleteError.classList.remove('hidden');
                            return;
                        }

                        await database.ref(`users/${userId}/padrinos/${sponsorToDeleteId}`).remove();
                        showToast('Padrino eliminado');
                        confirmModal.classList.add('hidden');
                    } catch (error) {
                        console.error('Error deleting sponsor:', error);
                        showToast('Error al eliminar padrino', 'error');
                    } finally {
                        deleteText.textContent = 'Eliminar';
                        deleteSpinner.classList.add('hidden');
                        confirmDeleteBtn.disabled = false;
                    }
                });
            } else {
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
    </script>
</body>
</html>