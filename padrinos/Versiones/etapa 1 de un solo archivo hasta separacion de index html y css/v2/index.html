<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Padrinos Misioneros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toast" class="toast hidden">
        <div class="flex items-center">
            <i id="toast-icon" class="fas fa-info-circle mr-2"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <div id="loginScreen" class="login-container gradient-bg p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-hands-helping text-blue-600 text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Padrinos Misioneros</h1>
                <p class="text-gray-600 mt-2">Inicia sesión para gestionar tus padrinos</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                           placeholder="tu@email.com">
                </div>
                
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                           placeholder="Tu contraseña">
                </div>
                
                <div id="loginError" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>
                
                <button type="submit" id="loginBtn" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center">
                    <span id="loginText">Iniciar Sesión</span>
                    <div id="loginSpinner" class="spinner hidden ml-2"></div>
                </button>
            </form>
            
            <p class="text-center text-gray-500 text-sm mt-6">
                ¿Necesitas acceso? Contacta al administrador.
            </p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-hands-helping text-2xl"></i>
                    <h1 class="text-xl font-bold">Padrinos Misioneros</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="userEmail" class="text-sm hidden sm:block"></span>
                    <button id="logoutBtn" class="bg-white text-blue-600 px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-50 transition-colors duration-300">
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-blue-100 p-3 mr-4">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Total Padrinos</p>
                        <h3 id="totalSponsors" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-green-100 p-3 mr-4">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Visitados</p>
                        <h3 id="visitedSponsors" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 shadow-md flex items-center">
                    <div class="rounded-full bg-red-100 p-3 mr-4">
                        <i class="fas fa-clock text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Pendientes</p>
                        <h3 id="pendingSponsors" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Gestión de Padrinos</h2>
                
                <div class="flex space-x-3">
                    <button id="addSponsorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-700 transition-colors duration-300 flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Nuevo Padrino
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar padrinos</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchInput" placeholder="Buscar por nombre, dirección..." 
                                   class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                        </div>
                    </div>
                    
                    <div>
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por estado</label>
                        <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                            <option value="all">Todos</option>
                            <option value="visited">Visitados</option>
                            <option value="pending">Pendientes</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="sectorFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por sector</label>
                        <select id="sectorFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                            <option value="all">Todos los sectores</option>
                            </select>
                    </div>
                </div>
            </div>

            <div id="sponsorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                </div>
            
            <div id="emptyState" class="hidden text-center py-12">
                <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-users text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay padrinos registrados</h3>
                <p class="text-gray-500 mb-6">Comienza agregando tu primer padrino</p>
                <button id="addFirstSponsorBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-colors duration-300">
                    <i class="fas fa-plus-circle mr-2"></i> Agregar primer padrino
                </button>
            </div>
        </main>

        <div id="sponsorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                <div class="flex justify-between items-center mb-4 pb-2 border-b">
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-800">Añadir Nuevo Padrino</h2>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="sponsorForm" class="space-y-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="nombre" name="nombre" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                               placeholder="Nombre completo (opcional)">
                    </div>
                    
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                        <input type="text" id="direccion" name="direccion" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                               placeholder="Dirección completa (opcional)">
                    </div>
                    
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="text" id="telefono" name="telefono" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                               placeholder="Número de teléfono (opcional)">
                    </div>
                    
                    <div>
                        <label for="correo" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="correo" name="correo" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                               placeholder="correo@ejemplo.com (opcional)">
                    </div>
                    
                    <div>
                        <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
                        <input type="text" id="sector" name="sector" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                               placeholder="Sector o zona (opcional)">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl hover:bg-gray-400 transition-colors duration-300">
                            Cancelar
                        </button>
                        <button type="submit" id="saveSponsorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors duration-300 flex items-center">
                            <span id="saveText">Guardar</span>
                            <div id="saveSpinner" class="spinner hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center">
                <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">¿Estás seguro?</h3>
                <p class="text-gray-600 mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-xl hover:bg-gray-400 transition-colors duration-300">
                        Cancelar
                    </button>
                    <button id="confirmDeleteBtn" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition-colors duration-300">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
        
        <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
                <div class="flex justify-between items-center mb-4 pb-2 border-b">
                    <h2 class="text-xl font-bold text-gray-800">Código QR del Padrino</h2>
                    <button id="closeQrModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="qrcode" class="mb-4"></div>
                <p class="text-sm text-gray-600">Escanea este código para ver los datos del padrino.</p>
            </div>
        </div>
        
        <div id="qrViewScreen" class="hidden login-container gradient-bg p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div class="mb-6">
                    <h2 id="qrViewTitle" class="text-3xl font-bold text-gray-800"></h2>
                    <p id="qrViewSubtitle" class="text-gray-600 mt-2"></p>
                </div>
                <div id="qrViewData" class="text-left space-y-4 text-gray-700">
                    <p><i class="fas fa-map-marker-alt text-blue-500 mr-2"></i> <span id="qrViewDireccion"></span></p>
                    <p><i class="fas fa-phone text-blue-500 mr-2"></i> <span id="qrViewTelefono"></span></p>
                    <p><i class="fas fa-envelope text-blue-500 mr-2"></i> <span id="qrViewCorreo"></span></p>
                    <p><i class="fas fa-tag text-blue-500 mr-2"></i> <span id="qrViewSector"></span></p>
                </div>
                <div class="mt-8">
                    <button id="markVisitedBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold shadow-md hover:bg-green-700 transition-all duration-300 flex items-center justify-center">
                        <span id="visitedText"><i class="fas fa-check-circle mr-2"></i> Marcar como Visitado</span>
                        <div id="visitedSpinner" class="spinner hidden ml-2"></div>
                    </button>
                    <p id="qrViewStatus" class="mt-4 text-lg font-bold text-gray-500"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCO3FRhSwH1xLABwVGFSd_YYrbFp0lQEv8",
            authDomain: "pagelalo-1b210.firebaseapp.com",
            databaseURL: "https://pagelalo-1b210-default-rtdb.firebaseio.com",
            projectId: "pagelalo-1b210",
            storageBucket: "pagelalo-1b210.firebasestorage.app",
            messagingSenderId: "1096735980204",
            appId: "1:1096735980204:web:8252ddb9fb484c398dfd09"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
    
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginError = document.getElementById('loginError');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const sponsorList = document.getElementById('sponsorList');
        const emptyState = document.getElementById('emptyState');
        const addSponsorBtn = document.getElementById('addSponsorBtn');
        const addFirstSponsorBtn = document.getElementById('addFirstSponsorBtn');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const sectorFilter = document.getElementById('sectorFilter');
        const sponsorModal = document.getElementById('sponsorModal');
        const modalTitle = document.getElementById('modalTitle');
        const sponsorForm = document.getElementById('sponsorForm');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveSponsorBtn = document.getElementById('saveSponsorBtn');
        const saveText = document.getElementById('saveText');
        const saveSpinner = document.getElementById('saveSpinner');
        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const totalSponsors = document.getElementById('totalSponsors');
        const visitedSponsors = document.getElementById('visitedSponsors');
        const pendingSponsors = document.getElementById('pendingSponsors');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');
        const qrModal = document.getElementById('qrModal');
        const qrcodeContainer = document.getElementById('qrcode');
        const closeQrModalBtn = document.getElementById('closeQrModalBtn');
        const qrViewScreen = document.getElementById('qrViewScreen');
        const qrViewTitle = document.getElementById('qrViewTitle');
        const qrViewDireccion = document.getElementById('qrViewDireccion');
        const qrViewTelefono = document.getElementById('qrViewTelefono');
        const qrViewCorreo = document.getElementById('qrViewCorreo');
        const qrViewSector = document.getElementById('qrViewSector');
        const markVisitedBtn = document.getElementById('markVisitedBtn');
        const visitedText = document.getElementById('visitedText');
        const visitedSpinner = document.getElementById('visitedSpinner');
        const qrViewStatus = document.getElementById('qrViewStatus');

        // State variables
        let editMode = false;
        let currentSponsorId = null;
        let userId = null;
        let sponsorToDeleteId = null;
        let sponsors = [];
        let filteredSponsors = [];
        let sectors = new Set();

        // Show toast notification
        const showToast = (message, type = 'success') => {
            toast.className = `toast ${type} show`;
            toastIcon.className = type === 'success' ? 'fas fa-check-circle mr-2' : 'fas fa-exclamation-circle mr-2';
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.className = 'toast hidden';
            }, 3000);
        };

        // Check if user is admin based on UID
        const checkAdminStatus = async (userId) => {
            try {
                return new Promise((resolve) => {
                    database.ref('admins').once('value', (snapshot) => {
                        const admins = snapshot.val();
                        // Check if the user ID exists in the admins list
                        const isAdmin = admins && admins[userId] === true;
                        resolve(isAdmin);
                    }, (error) => {
                        console.error("Error checking admin status:", error);
                        showToast('Error al verificar permisos', 'error');
                        resolve(false);
                    });
                });
            } catch (error) {
                console.error("Error checking admin status:", error);
                showToast('Error al verificar permisos de administrador', 'error');
                return false;
            }
        };

        // Function to format timestamp
        const formatVisitDate = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
            return `Visitado el ${date.toLocaleDateString('es-ES', options)}`;
        };
        
        // --- NUEVAS FUNCIONES PARA QR ---

        const createQrUrl = (sponsorId) => {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?mode=qr&id=${sponsorId}`;
        };

        const renderQrModal = (sponsorId) => {
            const qrUrl = createQrUrl(sponsorId);
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, {
                text: qrUrl,
                width: 256,
                height: 256,
            });
            qrModal.classList.remove('hidden');
        };

        const renderQrView = async (sponsorId) => {
            const userRef = database.ref(`users/${userId}/padrinos/${sponsorId}`);
            
            // Check if the QR URL is valid
            const snapshot = await userRef.once('value');
            if (!snapshot.exists()) {
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                showToast('QR inválido o padrino no encontrado', 'error');
                return;
            }

            const sponsor = snapshot.val();
            
            // Render UI
            qrViewScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginScreen.classList.add('hidden');

            qrViewTitle.textContent = sponsor.nombre || 'Padrino';
            qrViewDireccion.textContent = sponsor.direccion || 'No especificado';
            qrViewTelefono.textContent = sponsor.telefono || 'No especificado';
            qrViewCorreo.textContent = sponsor.correo || 'No especificado';
            qrViewSector.textContent = sponsor.sector || 'No especificado';

            if (sponsor.visitadoEn) {
                qrViewStatus.textContent = `Estado: Visitado`;
                markVisitedBtn.classList.add('hidden');
            } else {
                qrViewStatus.textContent = `Estado: Pendiente`;
                markVisitedBtn.classList.remove('hidden');
            }
            
            // Event listener for marking as visited
            markVisitedBtn.onclick = async () => {
                visitedText.textContent = 'Actualizando...';
                visitedSpinner.classList.remove('hidden');
                markVisitedBtn.disabled = true;

                try {
                    await userRef.update({ visitadoEn: Date.now() });
                    showToast('Padrino marcado como visitado', 'success');
                    qrViewStatus.textContent = `Estado: Visitado`;
                    markVisitedBtn.classList.add('hidden');
                } catch (e) {
                    console.error("Error updating document: ", e);
                    showToast('Error al actualizar el estado', 'error');
                } finally {
                    visitedText.textContent = 'Marcar como Visitado';
                    visitedSpinner.classList.add('hidden');
                    markVisitedBtn.disabled = false;
                }
            };
        };

        // --- FIN NUEVAS FUNCIONES PARA QR ---

        // Function to create a read-only sponsor card for the main list
        const createMainSponsorCard = (sponsor) => {
            const isVisited = !!sponsor.visitadoEn;
            const statusText = isVisited ? 'Visitado' : 'Pendiente';
            const statusColor = isVisited ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            const statusIcon = isVisited ? 'fa-check-circle' : 'fa-clock';
            const visitDateText = isVisited ? formatVisitDate(sponsor.visitadoEn) : '';

            return `
                <div class="bg-white rounded-2xl shadow-md p-6 card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${sponsor.nombre || 'Sin nombre'}</h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" data-id="${sponsor.id}" class="sr-only peer toggle-visited-btn" ${isVisited ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${sponsor.direccion ? `
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-map-marker-alt mr-2 w-5"></i>
                            <span class="text-sm">${sponsor.direccion}</span>
                        </div>
                        ` : ''}
                        
                        ${sponsor.telefono ? `
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-phone mr-2 w-5"></i>
                            <span class="text-sm">${sponsor.telefono}</span>
                        </div>
                        ` : ''}
                        
                        ${sponsor.correo ? `
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-envelope mr-2 w-5"></i>
                            <span class="text-sm">${sponsor.correo}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-between items-center">
                        ${sponsor.sector ? `
                        <span class="inline-block px-3 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full">${sponsor.sector}</span>
                        ` : '<span></span>'}
                        
                        <div class="flex items-center ${isVisited ? 'text-green-600' : 'text-red-600'}">
                            <i class="fas ${statusIcon} mr-1 text-sm"></i>
                            <span class="text-sm font-medium">${statusText}</span>
                        </div>
                    </div>
                    
                    ${visitDateText ? `<div class="text-xs text-gray-500 mt-3">${visitDateText}</div>` : ''}
                    
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="qr-btn text-purple-500 hover:text-purple-700 transition-colors duration-200" data-id="${sponsor.id}">
                            <i class="fas fa-qrcode"></i>
                        </button>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 transition-colors duration-200" data-id="${sponsor.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${sponsor.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        };

        // Update sectors list for filtering
        const updateSectorsList = () => {
            sectors.clear();
            sponsors.forEach(sponsor => {
                if (sponsor.sector) {
                    sectors.add(sponsor.sector);
                }
            });
            
            // Update sector filter dropdown
            sectorFilter.innerHTML = '<option value="all">Todos los sectores</option>';
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });
        };

        // Filter sponsors based on search, status and sector
        const filterSponsors = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const sectorValue = sectorFilter.value;
            
            filteredSponsors = sponsors.filter(sponsor => {
                // Check search term
                const matchesSearch = searchTerm === '' || 
                                    (sponsor.nombre && sponsor.nombre.toLowerCase().includes(searchTerm)) || 
                                    (sponsor.sector && sponsor.sector.toLowerCase().includes(searchTerm)) ||
                                    (sponsor.direccion && sponsor.direccion.toLowerCase().includes(searchTerm));
                
                // Check status
                const matchesStatus = statusValue === 'all' || 
                                    (statusValue === 'visited' && sponsor.visitadoEn) || 
                                    (statusValue === 'pending' && !sponsor.visitadoEn);
                
                // Check sector
                const matchesSector = sectorValue === 'all' || 
                                    (sponsor.sector && sponsor.sector === sectorValue);
                
                return matchesSearch && matchesStatus && matchesSector;
            });
            
            renderMainList(filteredSponsors);
        };

        // Function to render the main list
        const renderMainList = (sponsorsData) => {
            // Update stats
            totalSponsors.textContent = sponsors.length;
            const visitedCount = sponsors.filter(s => s.visitadoEn).length;
            visitedSponsors.textContent = visitedCount;
            pendingSponsors.textContent = sponsors.length - visitedCount;
            
            // Show empty state if no sponsors
            if (sponsorsData.length === 0) {
                sponsorList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            sponsorList.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Custom sorting: unvisited first, then visited. Within each group, sort by name.
            sponsorsData.sort((a, b) => {
                const aVisited = !!a.visitadoEn;
                const bVisited = !!b.visitadoEn;
                if (aVisited && !bVisited) return 1;
                if (!aVisited && bVisited) return -1;
                
                const aName = a.nombre || '';
                const bName = b.nombre || '';
                return aName.localeCompare(bName);
            });

            sponsorList.innerHTML = sponsorsData.map(sponsor => createMainSponsorCard(sponsor)).join('');
        };

        // Function to open the modal
        const openModal = (sponsor = null) => {
            sponsorModal.classList.remove('hidden');
            if (sponsor) {
                document.getElementById('nombre').value = sponsor.nombre || '';
                document.getElementById('direccion').value = sponsor.direccion || '';
                document.getElementById('telefono').value = sponsor.telefono || '';
                document.getElementById('correo').value = sponsor.correo || '';
                document.getElementById('sector').value = sponsor.sector || '';
                currentSponsorId = sponsor.id;
                editMode = true;
                modalTitle.textContent = 'Editar Padrino';
                saveText.textContent = 'Guardar Cambios';
            } else {
                sponsorForm.reset();
                currentSponsorId = null;
                editMode = false;
                modalTitle.textContent = 'Añadir Nuevo Padrino';
                saveText.textContent = 'Guardar';
            }
        };

        // Function to close the modal
        const closeModal = () => {
            sponsorModal.classList.add('hidden');
            sponsorForm.reset();
            editMode = false;
            currentSponsorId = null;
            saveText.textContent = 'Guardar';
            saveSpinner.classList.add('hidden');
        };

        // Event Listeners
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = loginEmail.value;
            const password = loginPassword.value;
            
            loginText.textContent = "Iniciando sesión...";
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            loginBtn.disabled = true;
            
            try {
                // First sign in with email and password
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Then check if user is admin by UID
                const isAdmin = await checkAdminStatus(user.uid);
                
                if (!isAdmin) {
                    // If not admin, sign out and show error
                    await auth.signOut();
                    throw new Error("No tienes permisos para acceder a esta aplicación. Contacta al administrador.");
                }
                
                showToast('Sesión iniciada correctamente');
            } catch (error) {
                console.error("Login error:", error);
                
                // Specific error messages
                let errorMessage = "Error al iniciar sesión";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Usuario no encontrado";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Contraseña incorrecta";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Email inválido";
                } else {
                    errorMessage = error.message || "Error al iniciar sesión. Verifica tus credenciales.";
                }
                
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
                loginText.textContent = "Iniciar Sesión";
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showToast('Sesión cerrada correctamente');
            } catch (error) {
                console.error("Logout error:", error);
                showToast('Error al cerrar sesión', 'error');
            }
        });

        addSponsorBtn.addEventListener('click', () => openModal());
        addFirstSponsorBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        closeQrModalBtn.addEventListener('click', () => qrModal.classList.add('hidden'));
        
        // Search and filter listeners
        searchInput.addEventListener('input', filterSponsors);
        statusFilter.addEventListener('change', filterSponsors);
        sectorFilter.addEventListener('change', filterSponsors);

        sponsorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            saveText.textContent = "Guardando...";
            saveSpinner.classList.remove('hidden');
            
            const sponsorData = {
                nombre: document.getElementById('nombre').value || null,
                direccion: document.getElementById('direccion').value || null,
                telefono: document.getElementById('telefono').value || null,
                correo: document.getElementById('correo').value || null,
                sector: document.getElementById('sector').value || null
            };
            
            // Remove null values
            Object.keys(sponsorData).forEach(key => {
                if (sponsorData[key] === null) {
                    delete sponsorData[key];
                }
            });
            
            try {
                if (editMode) {
                    // Update existing sponsor
                    await database.ref(`users/${userId}/padrinos/${currentSponsorId}`).update(sponsorData);
                    showToast('Padrino actualizado correctamente');
                } else {
                    // Add new sponsor
                    const newSponsorRef = database.ref(`users/${userId}/padrinos`).push();
                    await newSponsorRef.set({
                        ...sponsorData,
                        visitadoEn: null
                    });
                    showToast('Padrino agregado correctamente');
                }
                closeModal();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                saveText.textContent = "Guardar";
                saveSpinner.classList.add('hidden');
                showToast('Error al guardar el padrino', 'error');
            }
        });

        // Listen for authentication state changes
        auth.onAuthStateChanged(async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const sponsorId = urlParams.get('id');

            if (mode === 'qr' && sponsorId) {
                // If the URL has a QR mode, we handle that view
                // We check if a user is logged in, but we handle the view regardless
                // because the QR is for public, one-time use
                renderQrView(sponsorId);

                // We don't want to show the main app or login screen
                mainApp.classList.add('hidden');
                loginScreen.classList.add('hidden');
                
            } else if (user) {
                // User is signed in
                userId = user.uid;
                userEmail.textContent = user.email;
                userEmail.classList.remove('hidden');
                
                // Check if user is admin
                const isAdmin = await checkAdminStatus(userId);
                
                if (!isAdmin) {
                    // If not admin, sign out
                    await auth.signOut();
                    loginError.textContent = "No tienes permisos para acceder a esta aplicación. Contacta al administrador.";
                    loginError.classList.remove('hidden');
                    return;
                }
                
                // Switch to main app view
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // Set up real-time listener for sponsors
                database.ref(`users/${userId}/padrinos`).on('value', (snapshot) => {
                    const sponsorsData = [];
                    snapshot.forEach(childSnapshot => {
                        sponsorsData.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    sponsors = sponsorsData;
                    filteredSponsors = sponsorsData;
                    
                    // Update sectors list
                    updateSectorsList();
                    
                    // Apply current filters
                    filterSponsors();
                }, (error) => {
                    console.error("Error listening to sponsors:", error);
                    showToast('Error al cargar los padrinos', 'error');
                });
                
                // Listeners for toggle buttons on the main list
                sponsorList.addEventListener('click', async (e) => {
                    if (e.target.closest('.toggle-visited-btn')) {
                        const toggleBtn = e.target.closest('.toggle-visited-btn');
                        const id = toggleBtn.dataset.id;
                        const isChecked = toggleBtn.checked;
                        
                        try {
                            if (isChecked) {
                                await database.ref(`users/${userId}/padrinos/${id}`).update({ 
                                    visitadoEn: Date.now() 
                                });
                                showToast('Marcado como visitado');
                            } else {
                                await database.ref(`users/${userId}/padrinos/${id}/visitadoEn`).remove();
                                showToast('Marcado como pendiente');
                            }
                        } catch (e) {
                            console.error("Error updating document: ", e);
                            toggleBtn.checked = !isChecked; // Revert visual state on error
                            showToast('Error al actualizar el estado', 'error');
                        }
                    } else if (e.target.closest('.edit-btn')) {
                        const id = e.target.closest('.edit-btn').dataset.id;
                        const sponsor = sponsors.find(s => s.id === id);
                        if (sponsor) {
                            openModal(sponsor);
                        }
                    } else if (e.target.closest('.delete-btn')) {
                        sponsorToDeleteId = e.target.closest('.delete-btn').dataset.id;
                        confirmModal.classList.remove('hidden');
                    } else if (e.target.closest('.qr-btn')) {
                        const id = e.target.closest('.qr-btn').dataset.id;
                        renderQrModal(id);
                    }
                });
                
                confirmDeleteBtn.addEventListener('click', async () => {
                    if (sponsorToDeleteId) {
                        try {
                            await database.ref(`users/${userId}/padrinos/${sponsorToDeleteId}`).remove();
                            showToast('Padrino eliminado correctamente');
                        } catch (e) {
                            console.error("Error deleting document: ", e);
                            showToast('Error al eliminar el padrino', 'error');
                        }
                        sponsorToDeleteId = null;
                        confirmModal.classList.add('hidden');
                    }
                });

                cancelDeleteBtn.addEventListener('click', () => {
                    sponsorToDeleteId = null;
                    confirmModal.classList.add('hidden');
                });
                
            } else {
                // User is signed out
                if (mode !== 'qr') {
                    mainApp.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }
                
                loginForm.reset();
                loginError.classList.add('hidden');
                loginText.textContent = "Iniciar Sesión";
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
                
                // Remove listeners to avoid conflicts
                if (userId) {
                    database.ref(`users/${userId}/padrinos`).off();
                }
            }
        });

        // Initialize the app
        const initApp = () => {
            console.log("App initialized");
        };

        initApp();
    </script>
</body>
</html>