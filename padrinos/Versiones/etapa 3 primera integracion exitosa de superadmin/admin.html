<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Padrinos Misioneros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 1000;
            transform: translateX(400px); transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #10B981; color: white; }
        .toast.error { background: #EF4444; color: white; }
        .toast.warning { background: #F59E0B; color: white; }
        .toast.info { background: #3B82F6; color: white; }
        .spinner {
            width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-active { background-color: #10B981; }
        .status-inactive { background-color: #EF4444; }
        .stats-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stats-card-2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stats-card-3 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stats-card-4 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .warning-box {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="toast" class="toast hidden">
        <div class="flex items-center">
            <i id="toast-icon" class="mr-2"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full bg-purple-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-purple-600 text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Panel Super Admin</h1>
                <p class="text-gray-600 mt-2">Sistema de gestión centralizada</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email de Administrador</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                           placeholder="superadmin@email.com">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div id="loginError" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>
                <button type="submit" id="loginBtn" 
                        class="w-full gradient-bg text-white py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                    <span id="loginText">Acceder al Panel</span>
                    <div id="loginSpinner" class="spinner hidden ml-2"></div>
                </button>
            </form>
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">Solo usuarios autorizados pueden acceder</p>
            </div>
        </div>
    </div>

    <div id="mainDashboard" class="hidden min-h-screen">
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-shield-alt text-2xl"></i>
                        <div>
                            <h1 class="text-xl font-bold">Panel Super Administrador</h1>
                            <p class="text-sm text-purple-200">Gestión de Padrinos Misioneros</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div id="currentUserEmail" class="font-medium text-sm"></div>
                            <div class="text-purple-200 text-xs">Super Administrador</div>
                        </div>
                        <button id="refreshDataBtn" class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-lg text-sm hover:bg-opacity-30 transition-colors duration-300">
                            <i class="fas fa-sync-alt mr-1"></i>Actualizar
                        </button>
                        <button id="logoutBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-50 transition-colors duration-300">
                            <i class="fas fa-sign-out-alt mr-1"></i>Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stats-card text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Total Promotores</p>
                            <h3 id="totalPromoters" class="text-3xl font-bold">0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card-2 text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Total Padrinos</p>
                            <h3 id="totalSponsors" class="text-3xl font-bold">0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-hands-helping text-2xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card-3 text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Total Recaudado</p>
                            <h3 id="totalCollected" class="text-3xl font-bold">$0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-dollar-sign text-2xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card-4 text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Promedio/Promotor</p>
                            <h3 id="averagePerPromoter" class="text-3xl font-bold">$0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">Gestión de Promotores</h2>
                        <p class="text-gray-600 text-sm">Administra las cuentas de los promotores misioneros</p>
                    </div>
                    <button id="addPromoterBtn" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center">
                        <i class="fas fa-user-plus mr-2"></i>
                        Crear Nuevo Promotor
                    </button>
                </div>

                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="searchPromoters" placeholder="Buscar promotores por nombre o email..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="all">Todos los estados</option>
                            <option value="active">Solo Activos</option>
                            <option value="disabled">Solo Deshabilitados</option>
                        </select>
                    </div>
                </div>

                <div id="promotersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div id="loadingState" class="col-span-full flex items-center justify-center py-12">
                        <div class="flex items-center text-gray-500">
                            <div class="spinner mr-3 border-gray-400 border-t-gray-600"></div>
                            Cargando promotores...
                        </div>
                    </div>
                </div>

                <div id="emptyState" class="hidden text-center py-12">
                    <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-users text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay promotores registrados</h3>
                    <p class="text-gray-500 mb-6">Crea el primer promotor para comenzar</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Crear/Editar Promotor -->
    <div id="promoterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 id="promoterModalTitle" class="text-2xl font-bold text-gray-800">Crear Nuevo Promotor</h2>
                <button id="closePromoterModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="promoterForm" class="space-y-4">
                <div>
                    <label for="promoterName" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                    <input type="text" id="promoterName" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                           placeholder="Nombre del promotor">
                </div>
                
                <div>
                    <label for="promoterEmail" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="promoterEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                           placeholder="email@ejemplo.com">
                </div>
                
                <div id="passwordSection">
                    <label for="promoterPassword" class="block text-sm font-medium text-gray-700 mb-2">Contraseña Temporal *</label>
                    <div class="relative">
                        <input type="password" id="promoterPassword" required 
                               class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                               placeholder="Mínimo 6 caracteres">
                        <button type="button" id="generatePasswordBtn" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-purple-600 hover:text-purple-800">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">El promotor deberá cambiar esta contraseña en su primer acceso</p>
                </div>

                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelPromoterBtn" 
                            class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="submit" id="savePromoterBtn" 
                            class="gradient-bg text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-300 flex items-center">
                        <span id="savePromoterText">Crear Promotor</span>
                        <div id="savePromoterSpinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalles del Promotor -->
    <div id="promoterDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 id="promoterDetailsTitle" class="text-2xl font-bold text-gray-800">Detalles del Promotor</h2>
                <button id="closePromoterDetailsBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="promoterDetailsContent">
            </div>
        </div>
    </div>

    <!-- Modal Confirmación Deshabilitar -->
    <div id="disableConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
            <div class="w-16 h-16 rounded-full bg-orange-100 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-slash text-orange-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">¿Deshabilitar Promotor?</h3>
            <p class="text-gray-600 mb-6 text-center">
                El promotor <strong id="disablePromoterName"></strong> no podrá acceder al sistema, pero sus datos se conservarán.
            </p>
            
            <div class="flex justify-center space-x-4">
                <button id="cancelDisableBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="confirmDisableBtn" 
                        class="bg-orange-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-orange-700 transition-colors duration-200 flex items-center">
                    <span id="disableButtonText">Deshabilitar</span>
                    <div id="disableSpinner" class="spinner hidden ml-2"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase v9+ imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getDatabase, ref, onValue, set, push, remove, get, update, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC2ElrNIrXrtydpZCe-ysoXfdoyITGjgZU",
            authDomain: "padrinosmg-30a2f.firebaseapp.com",
            databaseURL: "https://padrinosmg-30a2f-default-rtdb.firebaseio.com",
            projectId: "padrinosmg-30a2f",
            storageBucket: "padrinosmg-30a2f.firebasestorage.app",
            messagingSenderId: "628189112208",
            appId: "1:628189112208:web:7044ab9b9b96656a657515"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Global variables
        let currentUser = null;
        let allPromoters = [];
        let filteredPromoters = [];
        let editingPromoterId = null;
        let promoterToDisable = null;
        let globalStats = { totalPromoters: 0, totalSponsors: 0, totalCollected: 0 };

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainDashboard = document.getElementById('mainDashboard');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const currentUserEmail = document.getElementById('currentUserEmail');

        // Modal elements
        const promoterModal = document.getElementById('promoterModal');
        const promoterDetailsModal = document.getElementById('promoterDetailsModal');
        const disableConfirmModal = document.getElementById('disableConfirmModal');

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast ${type} show`;
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            toastIcon.className = `${icons[type] || icons.info} mr-2`;
            toastMessage.textContent = message;
            
            setTimeout(() => { toast.className = 'toast hidden'; }, 4000);
        }

        function generateRandomPassword(length = 8) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Authentication
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            loginText.textContent = "Verificando acceso...";
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            loginBtn.disabled = true;
            
            try {
                await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPassword.value);
            } catch (error) {
                let msg = "Error al iniciar sesión";
                switch (error.code) {
                    case 'auth/user-not-found': msg = "Usuario no encontrado"; break;
                    case 'auth/wrong-password': msg = "Contraseña incorrecta"; break;
                    case 'auth/invalid-email': msg = "Email inválido"; break;
                    case 'auth/too-many-requests': msg = "Demasiados intentos. Intenta más tarde"; break;
                    case 'auth/invalid-credential': msg = "Credenciales inválidas"; break;
                }
                loginError.textContent = msg;
                loginError.classList.remove('hidden');
            } finally {
                loginText.textContent = "Acceder al Panel";
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Sesión cerrada correctamente', 'success');
            } catch (error) {
                showToast('Error al cerrar sesión', 'error');
            }
        });

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Verificar si es el primer usuario (auto-crear como superadmin)
                    const userManagementRef = ref(database, 'userManagement');
                    const snapshot = await get(userManagementRef);
                    
                    if (!snapshot.exists()) {
                        // Primera vez - crear estructura inicial
                        await set(ref(database, `userManagement/users/${user.uid}`), {
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            createdAt: Date.now(),
                            status: 'active'
                        });
                        
                        await set(ref(database, `userManagement/roles/${user.uid}`), 'superadmin');
                        showToast('Primera configuración completada. Eres el Super Administrador.', 'success');
                    }
                    
                    // Verificar rol del usuario
                    const userRoleRef = ref(database, `userManagement/roles/${user.uid}`);
                    const roleSnapshot = await get(userRoleRef);
                    const userRole = roleSnapshot.val();
                    
                    if (userRole === 'superadmin') {
                        currentUser = user;
                        currentUserEmail.textContent = user.email;
                        loginScreen.classList.add('hidden');
                        mainDashboard.classList.remove('hidden');
                        await loadAllData();
                    } else {
                        showToast('No tienes permisos de Super Administrador.', 'error');
                        await signOut(auth);
                    }
                    
                } catch (error) {
                    console.error('Error during authentication:', error);
                    showToast('Error de autenticación: ' + error.message, 'error');
                }
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                mainDashboard.classList.add('hidden');
            }
        });

        // Data Loading Functions
        async function loadAllData() {
            try {
                const loadingElement = document.getElementById('loadingState');
                if (loadingElement) {
                    loadingElement.classList.remove('hidden');
                }
                
                await Promise.all([
                    loadPromoters(),
                    calculateGlobalStats()
                ]);
                
                renderPromoters();
                updateGlobalStats();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error al cargar los datos: ' + error.message, 'error');
            } finally {
                const loadingElement = document.getElementById('loadingState');
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
            }
        }

        async function loadPromoters() {
            try {
                const usersRef = ref(database, 'userManagement/users');
                const rolesRef = ref(database, 'userManagement/roles');
                
                const [usersSnapshot, rolesSnapshot] = await Promise.all([
                    get(usersRef),
                    get(rolesRef)
                ]);
                
                const users = usersSnapshot.val() || {};
                const roles = rolesSnapshot.val() || {};
                
                allPromoters = [];
                
                for (const [uid, userData] of Object.entries(users)) {
                    if (userData && typeof userData === 'object' && userData.email) {
                        const role = roles[uid] || 'promoter';
                        
                        // Get sponsor statistics for promoters
                        let sponsorStats = { count: 0, collected: 0, completed: 0, pending: 0 };
                        
                        if (role === 'promoter') {
                            sponsorStats = await getPromoterStats(uid);
                        }
                        
                        allPromoters.push({
                            uid,
                            ...userData,
                            role,
                            ...sponsorStats,
                            lastActivity: userData.lastLogin || userData.createdAt || Date.now()
                        });
                    }
                }
                
                // Sort by role (super admins first) then by last activity
                allPromoters.sort((a, b) => {
                    if (a.role !== b.role) {
                        return a.role === 'superadmin' ? -1 : 1;
                    }
                    return b.lastActivity - a.lastActivity;
                });
                
                filteredPromoters = [...allPromoters];
            } catch (error) {
                console.error('Error loading promoters:', error);
                allPromoters = [];
                filteredPromoters = [];
            }
        }

        async function getPromoterStats(uid) {
            try {
                const padrinosRef = ref(database, `users/${uid}/padrinos`);
                const snapshot = await get(padrinosRef);
                
                if (!snapshot.exists()) {
                    return { count: 0, collected: 0, completed: 0, pending: 0 };
                }
                
                const padrinos = snapshot.val();
                const sponsors = Object.values(padrinos);
                
                let collected = 0;
                let completed = 0;
                let pending = 0;
                
                sponsors.forEach(sponsor => {
                    const status = getSponsorStatus(sponsor);
                    if (status === 'completed') {
                        completed++;
                        if (sponsor.visits) {
                            const visits = Object.values(sponsor.visits);
                            const lastVisit = visits.sort((a, b) => b.timestamp - a.timestamp)[0];
                            if (lastVisit && lastVisit.status === 'completed') {
                                collected += (lastVisit.amount || 0);
                            }
                        }
                    } else {
                        pending++;
                    }
                });
                
                return {
                    count: sponsors.length,
                    collected,
                    completed,
                    pending
                };
            } catch (error) {
                console.error(`Error loading stats for promoter ${uid}:`, error);
                return { count: 0, collected: 0, completed: 0, pending: 0 };
            }
        }

        function getSponsorStatus(sponsor) {
            if (!sponsor.visits || Object.keys(sponsor.visits).length === 0) {
                return 'pending';
            }
            const sortedVisits = Object.values(sponsor.visits).sort((a, b) => b.timestamp - a.timestamp);
            const lastVisit = sortedVisits[0];
            return lastVisit.status === 'completed' ? 'completed' : 'pending';
        }

        async function calculateGlobalStats() {
            let totalPromoters = 0;
            let totalSponsors = 0;
            let totalCollected = 0;
            
            allPromoters.forEach(promoter => {
                if (promoter.role === 'promoter' && promoter.status === 'active') {
                    totalPromoters++;
                    totalSponsors += promoter.count || 0;
                    totalCollected += promoter.collected || 0;
                }
            });
            
            globalStats = { totalPromoters, totalSponsors, totalCollected };
        }

        function updateGlobalStats() {
            document.getElementById('totalPromoters').textContent = globalStats.totalPromoters;
            document.getElementById('totalSponsors').textContent = globalStats.totalSponsors;
            document.getElementById('totalCollected').textContent = `${globalStats.totalCollected.toFixed(2)}`;
            
            const average = globalStats.totalPromoters > 0 ? 
                globalStats.totalCollected / globalStats.totalPromoters : 0;
            document.getElementById('averagePerPromoter').textContent = `${average.toFixed(2)}`;
        }

        // Rendering Functions
        function renderPromoters() {
            const grid = document.getElementById('promotersGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (!grid || !emptyState) {
                console.error('Required DOM elements not found');
                return;
            }
            
            if (filteredPromoters.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            grid.innerHTML = filteredPromoters.map(createPromoterCard).join('');
        }

        function createPromoterCard(promoter) {
            const isCurrentUser = currentUser && currentUser.uid === promoter.uid;
            const roleColor = promoter.role === 'superadmin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
            const roleIcon = promoter.role === 'superadmin' ? 'fas fa-shield-alt' : 'fas fa-user';
            const statusColor = promoter.status === 'active' ? 'status-active' : 'status-inactive';
            const statusText = promoter.status === 'active' ? 'Activo' : 'Deshabilitado';
            const cardOpacity = promoter.status === 'disabled' ? 'opacity-60' : '';
            
            return `
                <div class="bg-white p-6 rounded-xl shadow-md card-hover ${isCurrentUser ? 'ring-2 ring-purple-500' : ''} ${cardOpacity}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="status-indicator ${statusColor}"></div>
                                <h3 class="text-lg font-semibold text-gray-800">${promoter.name}</h3>
                                ${isCurrentUser ? '<span class="ml-2 text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Tú</span>' : ''}
                            </div>
                            <p class="text-gray-600 text-sm mb-2">${promoter.email}</p>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${roleColor}">
                                    <i class="${roleIcon} mr-1"></i>
                                    ${promoter.role === 'superadmin' ? 'Super Admin' : 'Promotor'}
                                </span>
                                <span class="text-xs text-gray-500">${statusText}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${promoter.role === 'promoter' && promoter.status === 'active' ? `
                        <div class="border-t pt-4 mb-4">
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-xl font-bold text-blue-600">${promoter.count || 0}</p>
                                    <p class="text-xs text-gray-600">Padrinos</p>
                                </div>
                                <div>
                                    <p class="text-xl font-bold text-green-600">${promoter.completed || 0}</p>
                                    <p class="text-xs text-gray-600">Completos</p>
                                </div>
                                <div>
                                    <p class="text-xl font-bold text-emerald-600">${(promoter.collected || 0).toFixed(0)}</p>
                                    <p class="text-xs text-gray-600">Recaudado</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end space-x-2 text-sm">
                        ${promoter.role === 'promoter' && promoter.status === 'active' ? `
                            <button onclick="viewPromoterDetails('${promoter.uid}')" 
                                    class="text-green-600 hover:text-green-800 px-3 py-1 rounded font-medium transition-colors duration-200">
                                <i class="fas fa-chart-bar mr-1"></i>Ver Detalles
                            </button>
                        ` : ''}
                        ${!isCurrentUser ? `
                            <button onclick="editPromoter('${promoter.uid}')" 
                                    class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded font-medium transition-colors duration-200">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </button>
                            ${promoter.role !== 'superadmin' ? `
                                <button onclick="togglePromoterStatus('${promoter.uid}', '${promoter.name}', '${promoter.status}')" 
                                        class="${promoter.status === 'active' ? 'text-orange-600 hover:text-orange-800' : 'text-green-600 hover:text-green-800'} px-3 py-1 rounded font-medium transition-colors duration-200">
                                    <i class="fas ${promoter.status === 'active' ? 'fa-user-slash' : 'fa-user-check'} mr-1"></i>
                                    ${promoter.status === 'active' ? 'Deshabilitar' : 'Habilitar'}
                                </button>
                            ` : ''}
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Promoter Management
        async function createPromoter(promoterData) {
            try {
                // Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, promoterData.email, promoterData.password);
                const newUser = userCredential.user;
                
                // Add to database
                await set(ref(database, `userManagement/users/${newUser.uid}`), {
                    name: promoterData.name,
                    email: promoterData.email,
                    createdAt: Date.now(),
                    status: 'active'
                });
                
                await set(ref(database, `userManagement/roles/${newUser.uid}`), 'promoter');
                
                return newUser;
            } catch (error) {
                console.error('Error creating promoter:', error);
                throw error;
            }
        }

        async function updatePromoter(uid, promoterData) {
            try {
                await update(ref(database, `userManagement/users/${uid}`), {
                    name: promoterData.name,
                    email: promoterData.email
                });
            } catch (error) {
                console.error('Error updating promoter:', error);
                throw error;
            }
        }

        async function togglePromoterStatus(uid, status) {
            try {
                const newStatus = status === 'active' ? 'disabled' : 'active';
                await update(ref(database, `userManagement/users/${uid}`), {
                    status: newStatus,
                    statusUpdatedAt: Date.now()
                });
                
                const actionText = newStatus === 'disabled' ? 'deshabilitado' : 'habilitado';
                showToast(`Promotor ${actionText} correctamente. ${newStatus === 'disabled' ? 'No podrá acceder al sistema.' : 'Ya puede acceder nuevamente.'}`, 'success');
                
            } catch (error) {
                console.error('Error toggling promoter status:', error);
                throw error;
            }
        }

        // Modal Functions
        function openPromoterModal(isEdit = false) {
            const modal = document.getElementById('promoterModal');
            const title = document.getElementById('promoterModalTitle');
            const saveText = document.getElementById('savePromoterText');
            const passwordSection = document.getElementById('passwordSection');
            const passwordField = document.getElementById('promoterPassword');
            
            title.textContent = isEdit ? 'Editar Promotor' : 'Crear Nuevo Promotor';
            saveText.textContent = isEdit ? 'Guardar Cambios' : 'Crear Promotor';
            
            if (isEdit) {
                passwordSection.style.display = 'none';
                passwordField.removeAttribute('required');
            } else {
                passwordSection.style.display = 'block';
                passwordField.setAttribute('required', 'required');
            }
            
            modal.classList.remove('hidden');
        }

        function closePromoterModal() {
            document.getElementById('promoterModal').classList.add('hidden');
            document.getElementById('promoterForm').reset();
            editingPromoterId = null;
        }

        async function viewPromoterDetails(uid) {
            try {
                const promoter = allPromoters.find(p => p.uid === uid);
                if (!promoter) return;
                
                document.getElementById('promoterDetailsTitle').textContent = `Detalles de ${promoter.name}`;
                
                // Load detailed sponsor data
                const padrinosRef = ref(database, `users/${uid}/padrinos`);
                const snapshot = await get(padrinosRef);
                
                let content = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-blue-600">${promoter.count || 0}</p>
                            <p class="text-blue-800 text-sm font-medium">Total Padrinos</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-600">${promoter.completed || 0}</p>
                            <p class="text-green-800 text-sm font-medium">Completados</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-yellow-600">${promoter.pending || 0}</p>
                            <p class="text-yellow-800 text-sm font-medium">Pendientes</p>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-emerald-600">${(promoter.collected || 0).toFixed(2)}</p>
                            <p class="text-emerald-800 text-sm font-medium">Recaudado</p>
                        </div>
                    </div>
                `;
                
                if (snapshot.exists()) {
                    const padrinos = snapshot.val();
                    const sponsors = Object.entries(padrinos).map(([id, data]) => ({ id, ...data }));
                    
                    content += `
                        <h3 class="text-lg font-semibold mb-4">Lista de Padrinos</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                    `;
                    
                    sponsors.forEach(sponsor => {
                        const status = getSponsorStatus(sponsor);
                        const statusColor = status === 'completed' ? 'text-green-600' : 'text-yellow-600';
                        const statusIcon = status === 'completed' ? 'fas fa-check-circle' : 'fas fa-clock';
                        const statusText = status === 'completed' ? 'Completado' : 'Pendiente';
                        const fullName = `${sponsor.tratamiento || ''} ${sponsor.nombre || 'Sin nombre'}`.trim();
                        
                        content += `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <h4 class="font-medium text-gray-800">${fullName}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${sponsor.direccion || 'Sin dirección'} | ${(sponsor.importe || 0).toFixed(2)}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="${statusColor} text-sm font-medium">
                                        <i class="${statusIcon} mr-1"></i>${statusText}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        ${sponsor.visits ? Object.keys(sponsor.visits).length : 0} visitas
                                    </p>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                } else {
                    content += `
                        <div class="text-center py-8">
                            <i class="fas fa-users text-gray-400 text-3xl mb-4"></i>
                            <p class="text-gray-500">Este promotor aún no ha registrado padrinos</p>
                        </div>
                    `;
                }
                
                document.getElementById('promoterDetailsContent').innerHTML = content;
                document.getElementById('promoterDetailsModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading promoter details:', error);
                showToast('Error al cargar los detalles del promotor', 'error');
            }
        }

        // Event Listeners
        document.getElementById('addPromoterBtn').addEventListener('click', () => {
            editingPromoterId = null;
            openPromoterModal(false);
        });

        document.getElementById('closePromoterModalBtn').addEventListener('click', closePromoterModal);
        document.getElementById('cancelPromoterBtn').addEventListener('click', closePromoterModal);

        document.getElementById('closePromoterDetailsBtn').addEventListener('click', () => {
            document.getElementById('promoterDetailsModal').classList.add('hidden');
        });

        document.getElementById('generatePasswordBtn').addEventListener('click', () => {
            document.getElementById('promoterPassword').value = generateRandomPassword();
        });

        document.getElementById('refreshDataBtn').addEventListener('click', async () => {
            refreshDataBtn.disabled = true;
            refreshDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Actualizando...';
            
            try {
                await loadAllData();
                showToast('Datos actualizados correctamente', 'success');
            } catch (error) {
                showToast('Error al actualizar los datos', 'error');
            } finally {
                refreshDataBtn.disabled = false;
                refreshDataBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Actualizar';
            }
        });

        // Search and Filter
        document.getElementById('searchPromoters').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredPromoters = allPromoters.filter(promoter => 
                promoter.name.toLowerCase().includes(searchTerm) ||
                promoter.email.toLowerCase().includes(searchTerm)
            );
            renderPromoters();
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            const statusFilter = e.target.value;
            filteredPromoters = allPromoters.filter(promoter => {
                if (statusFilter === 'all') return true;
                return promoter.status === statusFilter;
            });
            renderPromoters();
        });

        // Form Submission
        document.getElementById('promoterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const saveBtn = document.getElementById('savePromoterBtn');
            const saveText = document.getElementById('savePromoterText');
            const saveSpinner = document.getElementById('savePromoterSpinner');
            
            saveText.textContent = editingPromoterId ? 'Guardando...' : 'Creando...';
            saveSpinner.classList.remove('hidden');
            saveBtn.disabled = true;
            
            const promoterData = {
                name: document.getElementById('promoterName').value.trim(),
                email: document.getElementById('promoterEmail').value.trim(),
                ...(editingPromoterId ? {} : { password: document.getElementById('promoterPassword').value })
            };
            
            try {
                if (editingPromoterId) {
                    await updatePromoter(editingPromoterId, promoterData);
                    showToast('Promotor actualizado correctamente', 'success');
                } else {
                    await createPromoter(promoterData);
                    showToast('Promotor creado correctamente', 'success');
                }
                
                closePromoterModal();
                await loadAllData();
            } catch (error) {
                let errorMessage = 'Error al procesar promotor';
                switch (error.code) {
                    case 'auth/email-already-in-use': errorMessage = 'Este email ya está registrado'; break;
                    case 'auth/weak-password': errorMessage = 'La contraseña debe tener al menos 6 caracteres'; break;
                    case 'auth/invalid-email': errorMessage = 'Email inválido'; break;
                }
                showToast(errorMessage, 'error');
            } finally {
                saveText.textContent = editingPromoterId ? 'Guardar Cambios' : 'Crear Promotor';
                saveSpinner.classList.add('hidden');
                saveBtn.disabled = false;
            }
        });

        // Disable/Enable Confirmation
        document.getElementById('cancelDisableBtn').addEventListener('click', () => {
            document.getElementById('disableConfirmModal').classList.add('hidden');
            promoterToDisable = null;
        });

        document.getElementById('confirmDisableBtn').addEventListener('click', async () => {
            if (!promoterToDisable) return;
            
            const disableBtn = document.getElementById('confirmDisableBtn');
            const disableText = document.getElementById('disableButtonText');
            const disableSpinner = document.getElementById('disableSpinner');
            
            disableText.textContent = promoterToDisable.status === 'active' ? 'Deshabilitando...' : 'Habilitando...';
            disableSpinner.classList.remove('hidden');
            disableBtn.disabled = true;
            
            try {
                await togglePromoterStatus(promoterToDisable.uid, promoterToDisable.status);
                document.getElementById('disableConfirmModal').classList.add('hidden');
                await loadAllData();
            } catch (error) {
                showToast('Error al cambiar estado del promotor', 'error');
            } finally {
                disableText.textContent = 'Cambiar Estado';
                disableSpinner.classList.add('hidden');
                disableBtn.disabled = false;
                promoterToDisable = null;
            }
        });

        // Global Functions for onclick handlers
        window.editPromoter = (uid) => {
            const promoter = allPromoters.find(p => p.uid === uid);
            if (!promoter) return;
            
            editingPromoterId = uid;
            document.getElementById('promoterName').value = promoter.name;
            document.getElementById('promoterEmail').value = promoter.email;
            openPromoterModal(true);
        };

        window.togglePromoterStatus = (uid, name, status) => {
            promoterToDisable = { uid, name, status };
            const actionText = status === 'active' ? 'deshabilitar' : 'habilitar';
            const actionDescription = status === 'active' ? 
                'no podrá acceder al sistema, pero sus datos se conservarán.' : 
                'podrá acceder al sistema nuevamente.';
            
            document.getElementById('disablePromoterName').textContent = name;
            document.querySelector('#disableConfirmModal p').innerHTML = 
                `El promotor <strong>${name}</strong> ${actionDescription}`;
            document.getElementById('disableConfirmModal h3').textContent = 
                `¿${status === 'active' ? 'Deshabilitar' : 'Habilitar'} Promotor?`;
            document.getElementById('confirmDisableBtn').innerHTML = 
                `<span id="disableButtonText">${status === 'active' ? 'Deshabilitar' : 'Habilitar'}</span>
                 <div id="disableSpinner" class="spinner hidden ml-2"></div>`;
            document.getElementById('disableConfirmModal').classList.remove('hidden');
        };

        window.viewPromoterDetails = viewPromoterDetails;
    </script>
</body>
</html>