<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Padrinos Misioneros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #10B981; color: white; }
        .toast.error { background: #EF4444; color: white; }
        .toast.warning { background: #F59E0B; color: white; }
        .toast.info { background: #3B82F6; color: white; }
        .spinner { width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-active { background-color: #10B981; }
        .status-inactive { background-color: #EF4444; }
        .stats-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stats-card-2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stats-card-3 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stats-card-4 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="toast" class="toast hidden">
        <div class="flex items-center">
            <i id="toast-icon" class="mr-2"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full bg-purple-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-purple-600 text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Panel Super Admin</h1>
                <p class="text-gray-600 mt-2">Sistema de gestión centralizada</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email de Administrador</label>
                    <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="superadmin@email.com">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div id="loginError" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm"></div>
                <button type="submit" id="loginBtn" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                    <span id="loginText">Acceder al Panel</span>
                    <div id="loginSpinner" class="spinner hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden min-h-screen">
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-shield-alt text-2xl"></i>
                        <div>
                            <h1 class="text-xl font-bold">Panel Super Administrador</h1>
                            <p class="text-sm text-purple-200">Gestión de Padrinos Misioneros</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div id="currentUserEmail" class="font-medium text-sm"></div>
                            <div class="text-purple-200 text-xs">Super Administrador</div>
                        </div>
                        <button id="refreshDataBtn" class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-lg text-sm hover:bg-opacity-30 transition-colors duration-300">
                            <i class="fas fa-sync-alt mr-1"></i>Actualizar
                        </button>
                        <button id="logoutBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-50 transition-colors duration-300">
                            <i class="fas fa-sign-out-alt mr-1"></i>Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 sm:p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stats-card text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Total Promotores</p>
                            <h3 id="totalPromoters" class="text-3xl font-bold">0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="stats-card-2 text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Total Padrinos</p>
                            <h3 id="totalSponsors" class="text-3xl font-bold">0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-hands-helping text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="stats-card-3 text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Total Recaudado</p>
                            <h3 id="totalCollected" class="text-3xl font-bold">$0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-dollar-sign text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="stats-card-4 text-white rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-90 text-sm font-medium">Promedio/Promotor</p>
                            <h3 id="averagePerPromoter" class="text-3xl font-bold">$0</h3>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Promoters Management -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">Gestión de Promotores</h2>
                        <p class="text-gray-600 text-sm">Administra las cuentas de los promotores misioneros</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="addPromoterBtn" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center">
                            <i class="fas fa-user-plus mr-2"></i>
                            Crear Nuevo Promotor
                        </button>
                        <button id="generateInviteBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center">
                            <i class="fas fa-link mr-2"></i>
                            Generar Invitación
                        </button>
                    </div>
                </div>

                <div id="promotersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div id="loadingState" class="col-span-full flex items-center justify-center py-12">
                        <div class="flex items-center text-gray-500">
                            <div class="spinner mr-3 border-gray-400 border-t-gray-600"></div>
                            Cargando promotores...
                        </div>
                    </div>
                </div>

                <div id="emptyState" class="hidden text-center py-12">
                    <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-users text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay promotores registrados</h3>
                    <p class="text-gray-500 mb-6">Crea el primer promotor para comenzar</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="inviteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Generar Invitación</h2>
                <button id="closeInviteModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="inviteEmail" class="block text-sm font-medium text-gray-700 mb-2">Email del Promotor (Opcional)</label>
                    <input type="email" id="inviteEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="email@ejemplo.com">
                </div>
                <div>
                    <label for="inviteExpiry" class="block text-sm font-medium text-gray-700 mb-2">Tiempo de expiración</label>
                    <select id="inviteExpiry" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <option value="1">1 día</option>
                        <option value="3">3 días</option>
                        <option value="7" selected>7 días</option>
                        <option value="30">30 días</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button id="cancelInviteBtn" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium">Cancelar</button>
                    <button id="generateInviteLinkBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium">
                        <span id="generateInviteText">Generar Invitación</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="showInviteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Invitación Generada</h2>
                <button id="closeShowInviteModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">¡Invitación creada exitosamente!</h3>
                    <p class="text-green-700 text-sm">Comparte este enlace con el nuevo promotor.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enlace de Invitación</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="inviteLink" readonly class="flex-1 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-sm">
                        <button id="copyInviteBtn" class="bg-blue-600 text-white px-4 py-3 rounded-lg">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="closeInviteSuccessBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium">Entendido</button>
                </div>
            </div>
        </div>
    </div>

    <div id="promoterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 id="promoterModalTitle" class="text-2xl font-bold text-gray-800">Crear Nuevo Promotor</h2>
                <button id="closePromoterModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="promoterForm" class="space-y-4">
                <div>
                    <label for="promoterName" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                    <input type="text" id="promoterName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="promoterEmail" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="promoterEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                </div>
                <div id="passwordSection">
                    <label for="promoterPassword" class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                    <input type="password" id="promoterPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                </div>
                <div class="flex justify-end space-x-4 pt-6">
                    <button type="button" id="cancelPromoterBtn" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg">Cancelar</button>
                    <button type="submit" id="savePromoterBtn" class="gradient-bg text-white px-6 py-3 rounded-lg">
                        <span id="savePromoterText">Crear Promotor</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewSponsorsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-screen overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 id="viewSponsorsTitle" class="text-2xl font-bold text-gray-800">Padrinos del Promotor</h2>
                <button id="closeViewSponsorsBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="sponsorsContent" class="space-y-4"></div>
        </div>
    </div>

    <div id="addSponsorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6 pb-4 border-b">
                <h2 id="addSponsorTitle" class="text-2xl font-bold text-gray-800">Agregar Padrino</h2>
                <button id="closeAddSponsorBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addSponsorForm" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="sponsorNumpad" class="block text-sm font-medium text-gray-700 mb-1">No. Padrino</label>
                        <input type="text" id="sponsorNumpad" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="sponsorNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                        <input type="text" id="sponsorNombre" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="sponsorTratamiento" class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label>
                        <select id="sponsorTratamiento" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">(Ninguno)</option>
                            <option value="SR">Sr.</option>
                            <option value="SRA">Sra.</option>
                            <option value="SRITA">Srita.</option>
                        </select>
                    </div>
                    <div>
                        <label for="sponsorImporte" class="block text-sm font-medium text-gray-700 mb-1">Importe *</label>
                        <input type="number" id="sponsorImporte" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.01" min="0">
                    </div>
                    <div>
                        <label for="sponsorTelefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="text" id="sponsorTelefono" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div>
                    <label for="sponsorDireccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                    <input type="text" id="sponsorDireccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="sponsorSector" class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
                        <input type="text" id="sponsorSector" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="sponsorEtiqueta" class="block text-sm font-medium text-gray-700 mb-1">Etiqueta</label>
                        <input type="text" id="sponsorEtiqueta" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" id="cancelAddSponsorBtn" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg">Cancelar</button>
                    <button type="submit" id="saveAddSponsorBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg">
                        <span id="saveAddSponsorText">Agregar Padrino</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getDatabase, ref, set, get, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC2ElrNIrXrtydpZCe-ysoXfdoyITGjgZU",
            authDomain: "padrinosmg-30a2f.firebaseapp.com",
            databaseURL: "https://padrinosmg-30a2f-default-rtdb.firebaseio.com",
            projectId: "padrinosmg-30a2f",
            storageBucket: "padrinosmg-30a2f.firebasestorage.app",
            messagingSenderId: "628189112208",
            appId: "1:628189112208:web:7044ab9b9b96656a657515"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Global variables
        let currentUser = null;
        let allPromoters = [];

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast ${type} show`;
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            toastIcon.className = `${icons[type]} mr-2`;
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.className = 'toast hidden';
            }, 4000);
        }

        // Firebase functions
        async function createPromoter(promoterData) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, promoterData.email, promoterData.password);
                const newUser = userCredential.user;
                
                await set(ref(database, `userManagement/users/${newUser.uid}`), {
                    name: promoterData.name,
                    email: promoterData.email,
                    createdAt: Date.now(),
                    status: 'active'
                });
                
                await set(ref(database, `userManagement/roles/${newUser.uid}`), 'promoter');
                return newUser;
            } catch (error) {
                throw error;
            }
        }

 async function generateInvitation(email, expiryDays) {
    try {
        const inviteId = 'invite_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const expiryDate = Date.now() + (expiryDays * 24 * 60 * 60 * 1000);

        const inviteData = {
            id: inviteId,
            createdBy: currentUser.uid,
            createdAt: Date.now(),
            expiresAt: expiryDate,
            email: email || null,
            used: false
        };

        await set(ref(database, `invitations/${inviteId}`), inviteData);

        // ✅ CORRECCIÓN: Generar URL correcta
        const currentPath = window.location.pathname;
        const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        const inviteUrl = window.location.origin + basePath + 'registro-promotor.html?invite=' + inviteId;

        console.log('URL de invitación generada:', inviteUrl); // Para verificar

        return { inviteId, inviteUrl, expiryDate, email };
    } catch (error) {
        throw error;
    }
}

        async function loadPromoters() {
            try {
                const usersRef = ref(database, 'userManagement/users');
                const rolesRef = ref(database, 'userManagement/roles');
                
                const [usersSnapshot, rolesSnapshot] = await Promise.all([
                    get(usersRef),
                    get(rolesRef)
                ]);
                
                const users = usersSnapshot.val() || {};
                const roles = rolesSnapshot.val() || {};
                
                allPromoters = [];
                
                for (const [uid, userData] of Object.entries(users)) {
                    if (userData && typeof userData === 'object' && userData.email) {
                        const role = roles[uid] || 'promoter';
                        
                        // Solo mostrar promotores, no superadmins
                        if (role === 'promoter') {
                            let sponsorCount = 0;
                            sponsorCount = await getPromoterSponsorCount(uid);
                            
                            allPromoters.push({
                                uid,
                                ...userData,
                                role,
                                sponsorCount
                            });
                        }
                    }
                }
                
                renderPromoters();
                updateStats();
                
            } catch (error) {
                console.error('Error cargando promotores:', error);
                showToast('Error al cargar promotores', 'error');
            }
        }

        async function getPromoterSponsorCount(uid) {
            try {
                const padrinosRef = ref(database, `users/${uid}/padrinos`);
                const snapshot = await get(padrinosRef);
                
                if (!snapshot.exists()) {
                    return 0;
                }
                
                const padrinos = snapshot.val();
                return Object.keys(padrinos).length;
            } catch (error) {
                return 0;
            }
        }

        function renderPromoters() {
            const grid = document.getElementById('promotersGrid');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            
            loadingState.classList.add('hidden');
            
            if (allPromoters.length === 0) {
                emptyState.classList.remove('hidden');
                grid.innerHTML = '';
                return;
            }
            
            emptyState.classList.add('hidden');
            
            const html = allPromoters.map(promoter => {
                const isCurrentUser = currentUser && currentUser.uid === promoter.uid;
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">${promoter.name}</h3>
                            ${isCurrentUser ? '<span class="ml-2 text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Tú</span>' : ''}
                        </div>
                        <p class="text-gray-600 text-sm mb-2">${promoter.email}</p>
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            Promotor
                        </span>
                        
                        <div class="mt-4 pt-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">${promoter.sponsorCount || 0}</span> padrinos
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="window.viewPromoterSponsors('${promoter.uid}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 rounded-lg hover:bg-blue-50 transition-colors">
                                    <i class="fas fa-eye mr-1"></i>Ver
                                </button>
                                <button onclick="window.addSponsorToPromoter('${promoter.uid}')" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium px-3 py-1 rounded-lg hover:bg-green-50 transition-colors">
                                    <i class="fas fa-plus mr-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = html;
        }

        // CORRECCIÓN: Funciones globales mejor definidas
        async function viewPromoterSponsors(promoterUid) {
            try {
                const promoter = allPromoters.find(p => p.uid === promoterUid);
                if (!promoter) return;
                
                document.getElementById('viewSponsorsTitle').textContent = `Padrinos de ${promoter.name}`;
                
                const padrinosRef = ref(database, `users/${promoterUid}/padrinos`);
                const snapshot = await get(padrinosRef);
                
                const sponsorsContent = document.getElementById('sponsorsContent');
                
                if (!snapshot.exists()) {
                    sponsorsContent.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-users text-gray-400 text-3xl mb-4"></i>
                            <p class="text-gray-500">Este promotor no tiene padrinos registrados</p>
                        </div>
                    `;
                } else {
                    const padrinos = snapshot.val();
                    const sponsorsList = Object.entries(padrinos).map(([id, data]) => ({ id, ...data }));
                    
                    let content = `
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-semibold text-blue-800">Total de padrinos: ${sponsorsList.length}</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    `;
                    
                    sponsorsList.forEach(sponsor => {
                        const fullName = `${sponsor.tratamiento || ''} ${sponsor.nombre || 'Sin nombre'}`.trim();
                        const importe = parseFloat(sponsor.importe || 0).toFixed(2);
                        
                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-800 mb-2">${fullName}</h4>
                                ${sponsor.numpad ? `<p class="text-xs text-gray-500 mb-1">No. ${sponsor.numpad}</p>` : ''}
                                <p class="text-sm text-gray-600 mb-1">${sponsor.direccion || 'Sin dirección'}</p>
                                <p class="text-sm font-medium text-green-600">Importe: $${importe}</p>
                                ${sponsor.telefono ? `<p class="text-sm text-gray-600">Tel: ${sponsor.telefono}</p>` : ''}
                                ${sponsor.sector ? `<p class="text-xs text-gray-500 mt-1">Sector: ${sponsor.sector}</p>` : ''}
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                    sponsorsContent.innerHTML = content;
                }
                
                document.getElementById('viewSponsorsModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error viewing sponsors:', error);
                showToast('Error al cargar los padrinos', 'error');
            }
        }

        async function addSponsorToPromoter(promoterUid) {
            const promoter = allPromoters.find(p => p.uid === promoterUid);
            if (!promoter) return;
            
            document.getElementById('addSponsorTitle').textContent = `Agregar Padrino a ${promoter.name}`;
            document.getElementById('addSponsorModal').classList.remove('hidden');
            
            window.currentPromoterForSponsor = promoterUid;
        }

        function updateStats() {
            const activePromoters = allPromoters.filter(p => p.role === 'promoter' && p.status === 'active').length;
            const totalSponsors = allPromoters.reduce((sum, p) => sum + (p.sponsorCount || 0), 0);
            
            const totalPromotersEl = document.getElementById('totalPromoters');
            const totalSponsorsEl = document.getElementById('totalSponsors');
            const totalCollectedEl = document.getElementById('totalCollected');
            const averagePerPromoterEl = document.getElementById('averagePerPromoter');
            
            if (totalPromotersEl) totalPromotersEl.textContent = activePromoters;
            if (totalSponsorsEl) totalSponsorsEl.textContent = totalSponsors;
            if (totalCollectedEl) totalCollectedEl.textContent = '$0.00';
            if (averagePerPromoterEl) averagePerPromoterEl.textContent = '$0.00';
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            
            loginText.textContent = "Verificando...";
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            loginBtn.disabled = true;
            
            try {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                let msg = "Error al iniciar sesión";
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        msg = "Usuario no encontrado";
                        break;
                    case 'auth/wrong-password':
                        msg = "Contraseña incorrecta";
                        break;
                    case 'auth/invalid-email':
                        msg = "Email inválido";
                        break;
                    case 'auth/invalid-credential':
                        msg = "Credenciales inválidas";
                        break;
                }
                
                loginError.textContent = msg;
                loginError.classList.remove('hidden');
                
            } finally {
                loginText.textContent = "Acceder al Panel";
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Sesión cerrada correctamente', 'success');
            } catch (error) {
                showToast('Error al cerrar sesión', 'error');
            }
        });

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Verificar que el usuario sea superadmin
                    const userRoleRef = ref(database, `userManagement/roles/${user.uid}`);
                    const roleSnapshot = await get(userRoleRef);
                    const userRole = roleSnapshot.val();
                    
                    if (userRole === 'superadmin') {
                        currentUser = user;
                        document.getElementById('currentUserEmail').textContent = user.email;
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainDashboard').classList.remove('hidden');
                        
                        await loadPromoters();
                        
                    } else {
                        showToast('No tienes permisos de Super Administrador.', 'error');
                        await signOut(auth);
                    }
                    
                } catch (error) {
                    console.error('Auth state error:', error);
                    showToast('Error de autenticación', 'error');
                }
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainDashboard').classList.add('hidden');
            }
        });

        // Modal event listeners
        document.getElementById('addPromoterBtn').addEventListener('click', () => {
            document.getElementById('promoterModal').classList.remove('hidden');
        });

        document.getElementById('generateInviteBtn').addEventListener('click', () => {
            document.getElementById('inviteModal').classList.remove('hidden');
        });

        document.getElementById('closePromoterModalBtn').addEventListener('click', () => {
            document.getElementById('promoterModal').classList.add('hidden');
        });

        document.getElementById('cancelPromoterBtn').addEventListener('click', () => {
            document.getElementById('promoterModal').classList.add('hidden');
        });

        document.getElementById('closeInviteModalBtn').addEventListener('click', () => {
            document.getElementById('inviteModal').classList.add('hidden');
        });

        document.getElementById('cancelInviteBtn').addEventListener('click', () => {
            document.getElementById('inviteModal').classList.add('hidden');
        });

        document.getElementById('closeShowInviteModalBtn').addEventListener('click', () => {
            document.getElementById('showInviteModal').classList.add('hidden');
        });

        document.getElementById('closeInviteSuccessBtn').addEventListener('click', () => {
            document.getElementById('showInviteModal').classList.add('hidden');
        });

        document.getElementById('closeViewSponsorsBtn').addEventListener('click', () => {
            document.getElementById('viewSponsorsModal').classList.add('hidden');
        });

        document.getElementById('closeAddSponsorBtn').addEventListener('click', () => {
            document.getElementById('addSponsorModal').classList.add('hidden');
            document.getElementById('addSponsorForm').reset();
        });

        document.getElementById('cancelAddSponsorBtn').addEventListener('click', () => {
            document.getElementById('addSponsorModal').classList.add('hidden');
            document.getElementById('addSponsorForm').reset();
        });

        // Form submissions
        document.getElementById('promoterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const saveBtn = document.getElementById('savePromoterBtn');
            const saveText = document.getElementById('savePromoterText');
            
            saveText.textContent = 'Creando...';
            saveBtn.disabled = true;
            
            const promoterData = {
                name: document.getElementById('promoterName').value.trim(),
                email: document.getElementById('promoterEmail').value.trim(),
                password: document.getElementById('promoterPassword').value
            };
            
            try {
                await createPromoter(promoterData);
                showToast('Promotor creado correctamente', 'success');
                document.getElementById('promoterModal').classList.add('hidden');
                document.getElementById('promoterForm').reset();
                await loadPromoters();
                
            } catch (error) {
                let errorMessage = 'Error al crear promotor';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este email ya está registrado';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La contraseña debe tener al menos 6 caracteres';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido';
                        break;
                }
                
                showToast(errorMessage, 'error');
                
            } finally {
                saveText.textContent = 'Crear Promotor';
                saveBtn.disabled = false;
            }
        });

        document.getElementById('generateInviteLinkBtn').addEventListener('click', async () => {
            const generateBtn = document.getElementById('generateInviteLinkBtn');
            const generateText = document.getElementById('generateInviteText');
            
            generateText.textContent = 'Generando...';
            generateBtn.disabled = true;
            
            const email = document.getElementById('inviteEmail').value.trim();
            const expiryDays = parseInt(document.getElementById('inviteExpiry').value);
            
            try {
                const result = await generateInvitation(email, expiryDays);
                
                document.getElementById('inviteModal').classList.add('hidden');
                document.getElementById('inviteLink').value = result.inviteUrl;
                document.getElementById('showInviteModal').classList.remove('hidden');
                
                showToast('Invitación generada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generating invitation:', error);
                showToast('Error al generar la invitación', 'error');
                
            } finally {
                generateText.textContent = 'Generar Invitación';
                generateBtn.disabled = false;
            }
        });

        document.getElementById('addSponsorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!window.currentPromoterForSponsor) {
                showToast('Error: No se ha seleccionado un promotor', 'error');
                return;
            }
            
            const saveBtn = document.getElementById('saveAddSponsorBtn');
            const saveText = document.getElementById('saveAddSponsorText');
            
            saveText.textContent = 'Guardando...';
            saveBtn.disabled = true;
            
            const sponsorData = {
                numpad: document.getElementById('sponsorNumpad').value.trim(),
                tratamiento: document.getElementById('sponsorTratamiento').value.trim(),
                nombre: document.getElementById('sponsorNombre').value.trim(),
                direccion: document.getElementById('sponsorDireccion').value.trim(),
                telefono: document.getElementById('sponsorTelefono').value.trim(),
                sector: document.getElementById('sponsorSector').value.trim(),
                importe: parseFloat(document.getElementById('sponsorImporte').value) || 0,
                etiqueta: document.getElementById('sponsorEtiqueta').value.trim(),
            };
            
            try {
                const newSponsorId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                
                await set(ref(database, `users/${window.currentPromoterForSponsor}/padrinos/${newSponsorId}`), sponsorData);
                
                showToast('Padrino agregado correctamente', 'success');
                document.getElementById('addSponsorModal').classList.add('hidden');
                document.getElementById('addSponsorForm').reset();
                
                await loadPromoters();
                
            } catch (error) {
                console.error('Error adding sponsor:', error);
                showToast('Error al agregar padrino', 'error');
                
            } finally {
                saveText.textContent = 'Agregar Padrino';
                saveBtn.disabled = false;
            }
        });

        document.getElementById('copyInviteBtn').addEventListener('click', () => {
            const inviteLink = document.getElementById('inviteLink');
            inviteLink.select();
            inviteLink.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showToast('Enlace copiado al portapapeles', 'success');
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(inviteLink.value).then(() => {
                        showToast('Enlace copiado al portapapeles', 'success');
                    }).catch(() => {
                        showToast('Error al copiar. Selecciona manualmente', 'warning');
                    });
                } else {
                    showToast('Error al copiar. Selecciona manualmente', 'warning');
                }
            }
        });

        document.getElementById('refreshDataBtn').addEventListener('click', async () => {
            const refreshBtn = document.getElementById('refreshDataBtn');
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Actualizando...';
            
            try {
                await loadPromoters();
                showToast('Datos actualizados correctamente', 'success');
            } catch (error) {
                showToast('Error al actualizar los datos', 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Actualizar';
            }
        });

        // CORRECCIÓN: Exponer funciones globales correctamente
        window.viewPromoterSponsors = viewPromoterSponsors;
        window.addSponsorToPromoter = addSponsorToPromoter;
    </script>
</body>
</html>