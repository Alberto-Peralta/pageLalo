<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Campa√±a Temporal Padrinos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body { font-family: Arial, sans-serif; margin:0; }

  /* Banner */
  .campana-padrinos {
    background: linear-gradient(135deg, #ffe082, #ffcc80);
    color: #4e342e;
    text-align: center;
    padding: 2em 1em;
    border-bottom: 4px solid #ff9800;
    animation: fadeIn 1s ease-in-out;
  }
  .contenedor-campana { max-width: 800px; margin:auto; }
  .campana-padrinos h2 { font-size: 2em; margin-bottom:0.5em; cursor:pointer; }
  .campana-padrinos p { font-size:1.2em; margin-bottom:1.5em; }

  /* Botones */
  .botones-campana { display:flex; justify-content:center; gap:1em; flex-wrap:wrap; margin-top:1em; }
  .btn-campana {
    background-color:#ff6f00; color:white;
    padding:0.8em 1.5em; font-weight:bold;
    border-radius:5px; text-decoration:none;
    display:inline-flex; align-items:center; justify-content:center;
    transition:0.3s; border:none; cursor:pointer;
  }
  .btn-campana:hover { background-color:#e65100; }
  .btn-campana.secundario {
    background-color:transparent; color:#4e342e; border:2px solid #ff6f00;
  }
  .btn-campana.secundario:hover { background-color:#ffcc80; color:#4e342e; }
  .btn-campana i { margin-right:0.5em; }
  .btn-accion {
    padding: 0.5em 1em;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    font-size: 0.8em;
  }
  .btn-editar {
    background-color: #4CAF50;
    color: white;
  }
  .btn-eliminar {
    background-color: #f44336;
    color: white;
  }
  .btn-accion:hover { opacity: 0.8; }

  @keyframes fadeIn { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }

  /* Modal */
  .modal { 
    display: none; 
    position: fixed; 
    z-index: 999; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.5); 
    justify-content: center; 
    align-items: center; 
  }
  .modal-content {
    background-color:#fff3e0; 
    padding:2em; 
    border-radius:10px;
    max-width:500px; 
    width:90%; 
    position:relative;
    max-height: 90vh; 
    overflow-y: auto;
  }
  .close { position:absolute; top:10px; right:15px; font-size:1.5em; cursor:pointer; }
  .modal-content input, .modal-content textarea { width:100%; padding:0.8em; margin-bottom:1em; border:1px solid #ccc; border-radius:5px; font-size:1em; }
  .modal-content textarea { resize:vertical; min-height:80px; }
  .mensaje-exito, .mensaje-error { font-weight:bold; margin-top:1em; display:none; }
  .form-group-flex {
    display: flex;
    align-items: flex-start;
    gap: 0.5em;
    margin-bottom: 1em;
  }

  /* Panel administrador */
  .panel-admin { display:none; padding:2em; background:#f5f5f5; }
  .panel-admin h2 { margin-top:0; }
  table { width:100%; border-collapse: collapse; margin-top:1em; }
  table, th, td { border:1px solid #ccc; }
  th, td { padding:0.5em; text-align:left; }

  /* Estilos responsivos para el panel administrador */
  @media (max-width: 768px) {
    .panel-admin {
      padding: 1em;
    }
    table {
      font-size: 0.9em;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    th, td {
      padding: 0.4em;
    }
  }

  /* Estilo para hacer la barra de scroll m√°s visible en Webkit (Chrome, Safari) */
  .modal-content::-webkit-scrollbar {
    width: 8px;
  }
  .modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  .modal-content::-webkit-scrollbar-thumb {
    background: #ff6f00;
    border-radius: 10px;
  }
  .modal-content::-webkit-scrollbar-thumb:hover {
    background: #e65100;
  }
</style>
</head>
<body>

  <section class="campana-padrinos">
    <div class="contenedor-campana">
      <h2>üéØ Convi√©rtete en Padrino de un Misionero</h2>
      <p>Tu generosidad puede llevar el Evangelio y la ayuda a donde m√°s se necesita. S√© parte del cambio.</p>

      <div class="botones-campana">
        <a href="https://wa.me/526393992678?text=Hola,%20quiero%20informaci√≥n%20sobre%20c√≥mo%20convertirme%20en%20padrino" 
           class="btn-campana" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-whatsapp"></i> Quiero info por WhatsApp
        </a>

        <button class="btn-campana secundario" id="btn-mostrar-formulario">Dejar mis datos</button>

        <a href="https://www.misionerosdeguadalupe.org" 
           class="btn-campana secundario" target="_blank" rel="noopener noreferrer">
          Conocer M√°s
        </a>
      </div>
      <div class="botones-campana" style="margin-top: 0.5em;">
        <a href="aviso-de-privacidad.html" target="_blank" rel="noopener noreferrer" style="color: #4e342e; font-size: 0.9em;">Aviso de Privacidad</a>
        <a href="faq.html" target="_blank" rel="noopener noreferrer" style="color: #4e342e; font-size: 0.9em;">Preguntas Frecuentes</a>
      </div>
    </div>
  </section>

  <div class="modal" id="modal-formulario">
    <div class="modal-content">
      <span class="close" id="cerrar-modal">&times;</span>
      <h2>Deja tus datos para contactarte</h2>
      <form id="form-padrinos">
        <input type="text" name="nombre" placeholder="Tu nombre" required>
        <input type="email" name="correo" placeholder="Tu correo" required>
        <input type="tel" name="telefono" placeholder="Tu tel√©fono" required>
        <textarea name="mensaje" placeholder="Comentario (opcional)"></textarea>
        <div class="form-group-flex">
            <input type="checkbox" id="aceptar-terminos" required style="width: auto; margin-top: 0.2em;">
            <label for="aceptar-terminos" style="font-size: 0.9em;">
                Acepto el <a href="aviso-de-privacidad.html" target="_blank" rel="noopener noreferrer" style="color: #ff6f00;">Aviso de Privacidad</a>.
            </label>
        </div>
        <button type="submit" class="btn-campana">Enviar</button>
      </form>
      <p class="mensaje-exito" id="mensaje-exito">¬°Gracias! Te contactaremos pronto.</p>
    </div>
  </div>

  <div class="modal" id="modal-login">
    <div class="modal-content">
      <span class="close" id="cerrar-login">&times;</span>
      <h2>Acceso Administrador</h2>
      <form id="form-login">
        <input type="email" name="correo" placeholder="Correo" required>
        <input type="password" name="password" placeholder="Contrase√±a" required>
        <button type="submit" class="btn-campana">Ingresar</button>
      </form>
      <p class="mensaje-error" id="mensaje-error">Correo o contrase√±a incorrectos</p>
    </div>
  </div>

  <div class="modal" id="modal-editar">
    <div class="modal-content">
      <span class="close" id="cerrar-editar">&times;</span>
      <h2>Editar Prospecto</h2>
      <form id="form-editar">
        <input type="hidden" id="edit-key">
        <input type="text" name="nombre" id="edit-nombre" placeholder="Tu nombre" required>
        <input type="email" name="correo" id="edit-correo" placeholder="Tu correo" required>
        <input type="tel" name="telefono" id="edit-telefono" placeholder="Tu tel√©fono" required>
        <textarea name="mensaje" id="edit-mensaje" placeholder="Comentario (opcional)"></textarea>
        <button type="submit" class="btn-campana">Guardar Cambios</button>
      </form>
      <p class="mensaje-exito" id="mensaje-exito-editar">¬°Cambios guardados con √©xito!</p>
    </div>
  </div>

  <section class="panel-admin" id="panel-admin">
    <h2>Panel de Administrador</h2>
    <button id="btn-logout" class="btn-campana secundario">Cerrar sesi√≥n</button>
    <table id="tabla-prospectos">
      <thead>
        <tr><th>Nombre</th><th>Correo</th><th>Tel√©fono</th><th>Mensaje</th><th>Fecha</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script type="module">
    // 1. IMPORTACIONES: Todas las funciones necesarias de Firebase en una sola l√≠nea.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // 2. CONFIGURACI√ìN DE FIREBASE Y VARIABLES GLOBALES
    const firebaseConfig = {
      apiKey: "AIzaSyCO3FRhSwH1xLABwVGFSd_YYrbFp0lQEv8",
      authDomain: "pagelalo-1b210.firebaseapp.com",
      databaseURL: "https://pagelalo-1b210-default-rtdb.firebaseio.com",
      projectId: "pagelalo-1b210",
      storageBucket: "pagelalo-1b210.firebasestorage.app",
      messagingSenderId: "1096735980204",
      appId: "1:1096735980204:web:8252ddb9fb484c398dfd09"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    // 3. VARIABLES Y EVENTOS DE LOS MODALES Y FORMULARIOS
    // Modal Formulario
    const modal = document.getElementById('modal-formulario');
    const btnMostrar = document.getElementById('btn-mostrar-formulario');
    const cerrarModal = document.getElementById('cerrar-modal');
    btnMostrar.addEventListener('click', () => {
      modal.style.display = 'flex';
      enviarAltura();
    });
    cerrarModal.addEventListener('click', () => {
      modal.style.display = 'none';
      enviarAltura();
    });
    window.addEventListener('click', (e) => { 
      if (e.target == modal) {
        modal.style.display = 'none'; 
        enviarAltura();
      }
    });

    // Guardar datos en Firebase
    const form = document.getElementById('form-padrinos');
    const mensajeExito = document.getElementById('mensaje-exito');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const datos = {
        nombre: form.nombre.value,
        correo: form.correo.value,
        telefono: form.telefono.value,
        mensaje: form.mensaje.value,
        fecha: new Date().toLocaleString()
      };
      push(ref(database, 'padrinos'), datos)
        .then(() => { 
          mensajeExito.style.display = 'block'; 
          form.reset(); 
        })
        .catch(err => alert('Error: ' + err));
    });

    // Modal Login Admin
    const modalLogin = document.getElementById('modal-login');
    const cerrarLogin = document.getElementById('cerrar-login');
    const tituloBanner = document.querySelector('.campana-padrinos h2');
    const formLogin = document.getElementById('form-login');
    const mensajeError = document.getElementById('mensaje-error');
    const panel = document.getElementById('panel-admin');

    let clicks = 0, timer;
    tituloBanner.addEventListener('click', () => {
      clicks++;
      clearTimeout(timer);
      timer = setTimeout(() => { clicks = 0; }, 1500);
      if (clicks >= 5) {
        modalLogin.style.display = 'flex';
        enviarAltura();
      }
    });
    cerrarLogin.addEventListener('click', () => {
      modalLogin.style.display = 'none';
      enviarAltura();
    });
    window.addEventListener('click', (e) => { 
      if (e.target == modalLogin) {
        modalLogin.style.display = 'none';
        enviarAltura();
      }
    });

    // Login con Firebase Authentication
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      const correo = formLogin.correo.value.trim();
      const password = formLogin.password.value.trim();

      try {
        await signInWithEmailAndPassword(auth, correo, password);
        modalLogin.style.display = 'none';
        panel.style.display = 'block';
        mostrarDatosAdmin();
        enviarAltura();
      } catch (error) {
        mensajeError.style.display = 'block';
        setTimeout(() => mensajeError.style.display = 'none', 3000);
      }
    });

    // Logout admin
    const btnLogout = document.getElementById('btn-logout');
    btnLogout.addEventListener('click', async () => {
      try {
        await signOut(auth);
        panel.style.display = 'none';
        alert('Has cerrado sesi√≥n correctamente.');
        enviarAltura();
      } catch (error) {
        alert('Error al cerrar sesi√≥n: ' + error.message);
      }
    });

    // 4. FUNCIONES DEL PANEL DE ADMINISTRACI√ìN
    function mostrarDatosAdmin() {
      const tablaBody = document.querySelector('#tabla-prospectos tbody');
      const padrinosRef = ref(database, 'padrinos');
      onValue(padrinosRef, snapshot => {
        tablaBody.innerHTML = '';
        snapshot.forEach(child => {
          const key = child.key;
          const data = child.val();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.nombre}</td>
            <td>${data.correo}</td>
            <td>${data.telefono}</td>
            <td>${data.mensaje}</td>
            <td>${data.fecha}</td>
            <td>
              <button class="btn-accion btn-editar" data-key="${key}">Editar</button>
              <button class="btn-accion btn-eliminar" data-key="${key}">Eliminar</button>
            </td>
          `;
          tablaBody.appendChild(tr);
        });
        enviarAltura();
      });
    }

    // 5. L√ìGICA DE EDICI√ìN Y ELIMINACI√ìN
    // Modal de edici√≥n
    const modalEditar = document.getElementById('modal-editar');
    const cerrarEditar = document.getElementById('cerrar-editar');
    const formEditar = document.getElementById('form-editar');
    const mensajeExitoEditar = document.getElementById('mensaje-exito-editar');

    // Abrir el modal de edici√≥n y llenar el formulario
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-editar')) {
        const key = e.target.dataset.key;
        const padrinoRef = ref(database, `padrinos/${key}`);
        onValue(padrinoRef, (snapshot) => {
          const data = snapshot.val();
          document.getElementById('edit-key').value = key;
          document.getElementById('edit-nombre').value = data.nombre;
          document.getElementById('edit-correo').value = data.correo;
          document.getElementById('edit-telefono').value = data.telefono;
          document.getElementById('edit-mensaje').value = data.mensaje;
          modalEditar.style.display = 'flex';
          enviarAltura();
        }, {
          onlyOnce: true
        });
      }
    });

    // Enviar formulario de edici√≥n
    formEditar.addEventListener('submit', (e) => {
      e.preventDefault();
      const key = document.getElementById('edit-key').value;
      const updates = {};
      updates[`/padrinos/${key}/nombre`] = document.getElementById('edit-nombre').value;
      updates[`/padrinos/${key}/correo`] = document.getElementById('edit-correo').value;
      updates[`/padrinos/${key}/telefono`] = document.getElementById('edit-telefono').value;
      updates[`/padrinos/${key}/mensaje`] = document.getElementById('edit-mensaje').value;

      update(ref(database), updates)
        .then(() => {
          mensajeExitoEditar.style.display = 'block';
          setTimeout(() => {
            mensajeExitoEditar.style.display = 'none';
            modalEditar.style.display = 'none';
            enviarAltura();
          }, 2000);
        })
        .catch((error) => {
          alert("Error al actualizar: " + error.message);
        });
    });

    // L√≥gica de eliminaci√≥n
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-eliminar')) {
        const key = e.target.dataset.key;
        if (confirm('¬øEst√°s seguro de que quieres eliminar este registro?')) {
          const padrinoRef = ref(database, `padrinos/${key}`);
          remove(padrinoRef)
            .then(() => {
              alert("Registro eliminado con √©xito.");
              enviarAltura();
            })
            .catch((error) => {
              alert("Error al eliminar: " + error.message);
            });
        }
      }
    });

    // Cierre del modal de edici√≥n
    cerrarEditar.addEventListener('click', () => {
      modalEditar.style.display = 'none';
      enviarAltura();
    });
    window.addEventListener('click', (e) => {
      if (e.target == modalEditar) {
        modalEditar.style.display = 'none';
        enviarAltura();
      }
    });
  </script>

  <script>
    function enviarAltura() {
      const altura = document.body.scrollHeight;
      window.parent.postMessage({ height: altura }, "*");
    }

    // Enviar altura al cargar y al cambiar tama√±o
    window.addEventListener('load', enviarAltura);
    window.addEventListener('resize', enviarAltura);
  </script>
</body>
</html>