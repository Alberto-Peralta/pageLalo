<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criptograma Bíblico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'EB Garamond', serif;
            background-color: #D4AF37; /* Mostaza profundo del fondo de la imagen */
            color: #2E1A00; /* Marrón muy oscuro, casi negro, para el texto */
        }
        .letter-container {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            margin: 0 2px;
        }
        .letter-input {
            font-family: 'EB Garamond', serif;
            border: none;
            border-bottom: 2px solid #8B4513; /* Marrón oscuro para el borde del input */
            background-color: transparent;
            text-transform: uppercase;
            caret-color: #8B4513;
        }
        .letter-input:focus {
            outline: none;
            border-bottom: 2px solid #FFD700; /* Oro para el enfoque */
        }
        .letter-input:disabled {
            color: #6B8E23; /* Verde oliva para letras reveladas */
            background-color: transparent;
            border-bottom-color: transparent;
        }
        .word-container {
            display: flex;
            align-items: flex-end;
            margin-right: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .encrypted-letter {
            font-size: 1.25rem;
            color: #2E1A00; /* Marrón muy oscuro para letras encriptadas */
            font-weight: 700;
        }
        .punctuation-mark {
            padding: 0 4px;
            font-size: 1.5rem;
            margin-bottom: -4px;
        }
        .btn-custom {
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-custom:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-custom:disabled {
            background-color: #A8A29E; /* Gris piedra para deshabilitado */
            cursor: not-allowed;
        }
        #message-box {
            transition: opacity 0.5s ease-in-out;
        }

        /* Estilos para el modal de configuración de exportación */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .alphabet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 15px;
            max-height: 200px; /* Limita la altura */
            overflow-y: auto; /* Agrega scroll si es necesario */
            padding-right: 10px; /* Espacio para la barra de desplazamiento */
        }
        .alphabet-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #2E1A00; /* Marrón muy oscuro para texto del alfabeto */
        }

        /* Estilo para el título temporal de exportación */
        .export-title {
            text-align: center;
            font-size: 2.5rem; /* Ajusta el tamaño según prefieras */
            font-weight: bold;
            color: #8B4513; /* Marrón oscuro para el título */
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #DAA520; /* Goldenrod para la línea */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="main-content" class="w-full max-w-5xl mx-auto bg-white/50 backdrop-blur-sm rounded-xl shadow-2xl p-6 md:p-8 border border-amber-600/50">
        
        <div class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900">Criptograma Bíblico</h1>
            <p class="text-lg text-amber-800 mt-2">Descifra la cita sagrada</p>
        </div>

        <div id="puzzle-container" class="flex flex-wrap justify-center p-4 min-h-[150px] items-center">
            </div>

        <div id="source-container" class="text-center mt-4 mb-6">
            <p id="source-text" class="text-xl font-bold text-amber-900"></p> 
        </div>

        <div id="controls" class="grid grid-cols-2 sm:flex sm:flex-row items-center justify-center gap-4 my-6">
            <button id="new-game-btn" class="btn-custom bg-amber-900 hover:bg-amber-950 text-white font-bold py-2 px-5 rounded-lg col-span-2">
                <i class="fa-solid fa-file-lines mr-2"></i>Nuevo Juego
            </button>
            <div class="flex items-center justify-center">
                   <button id="reveal-letter-btn" class="btn-custom bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-5 rounded-lg">
                    <i class="fa-solid fa-lightbulb mr-2"></i>Revelar
                </button>
                <span id="reveal-count" class="ml-2 bg-yellow-200 text-yellow-900 font-bold text-sm rounded-full h-6 w-6 flex items-center justify-center"></span>
            </div>
            <button id="undo-btn" class="btn-custom bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-5 rounded-lg">
                <i class="fa-solid fa-rotate-left mr-2"></i>Deshacer
            </button>
            <button id="check-solution-btn" class="btn-custom bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-5 rounded-lg">
                <i class="fa-solid fa-check mr-2"></i>Verificar
            </button>
            <button id="open-export-modal-btn" class="btn-custom bg-orange-700 hover:bg-orange-800 text-white font-bold py-2 px-5 rounded-lg">
                   <i class="fa-solid fa-file-export mr-2"></i>Exportar a PDF
            </button>
        </div>

        <div id="message-box" class="text-center mt-4 h-8">
               <p id="message-text" class="text-xl font-semibold"></p>
        </div>

    </div>

    <div id="export-config-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-modal-btn">&times;</span>
            <h2 class="text-2xl font-bold text-amber-800 mb-4">Configuración de Exportación</h2>
            
            <div class="mb-4">
                <label for="export-pdf-title" class="block text-amber-700 text-sm font-bold mb-2">Título del PDF / Encabezado de la Hoja:</label>
                <input type="text" id="export-pdf-title" placeholder="Criptograma Bíblico" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-yellow-400">
            </div>

            <div class="mb-6">
                <label class="block text-amber-700 text-sm font-bold mb-2">Letras a revelar en el PDF (opcional):</label>
                <div id="alphabet-checkboxes" class="alphabet-grid">
                    </div>
            </div>

            <button id="generate-pdf-btn" class="btn-custom bg-orange-700 hover:bg-orange-800 text-white font-bold py-2 px-5 rounded-lg w-full">
                <i class="fa-solid fa-file-pdf mr-2"></i>Generar PDF
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DEL DOM ---
            const elements = {
                mainContent: document.getElementById('main-content'), 
                puzzleContainer: document.getElementById('puzzle-container'),
                sourceText: document.getElementById('source-text'),
                newGameBtn: document.getElementById('new-game-btn'),
                revealLetterBtn: document.getElementById('reveal-letter-btn'),
                checkSolutionBtn: document.getElementById('check-solution-btn'),
                messageText: document.getElementById('message-text'),
                openExportModalBtn: document.getElementById('open-export-modal-btn'),
                undoBtn: document.getElementById('undo-btn'),
                revealCount: document.getElementById('reveal-count'),
                exportConfigModal: document.getElementById('export-config-modal'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                exportPdfTitleInput: document.getElementById('export-pdf-title'),
                alphabetCheckboxesContainer: document.getElementById('alphabet-checkboxes'),
                generatePdfBtn: document.getElementById('generate-pdf-btn'),
                gameMainTitle: document.querySelector('#main-content .text-center h1'), 
                gameSubtitle: document.querySelector('#main-content .text-center p') 
            };

            // --- DATOS DEL JUEGO ---
            const quotes = [
                { text: "PORQUE DE TAL MANERA AMO DIOS AL MUNDO QUE HA DADO A SU HIJO UNIGENITO PARA QUE TODO AQUEL QUE EN EL CREE NO SE PIERDA MAS TENGA VIDA ETERNA", source: "Juan 3:16" },
                { text: "EL SEÑOR ES MI PASTOR NADA ME FALTARA", source: "Salmo 23:1" },
                { text: "TODO LO PUEDO EN CRISTO QUE ME FORTALECE", source: "Filipenses 4:13" },
                { text: "EN EL PRINCIPIO CREO DIOS LOS CIELOS Y LA TIERRA", source: "Génesis 1:1" },
                { text: "YO SOY EL CAMINO Y LA VERDAD Y LA VIDA NADIE VIENE AL PADRE SINO POR MI", source: "Juan 14:6" },
                { text: "EL AMOR ES PACIENTE ES BONDADOSO EL AMOR NO ES ENVIDIOSO NI JACTANCIOSO NI ORGULLOSO", source: "1 Corintios 13:4" },
                { text: "ESFORZAOS Y COBRAD ANIMO NO TEMAIS NI TENGAIS MIEDO DE ELLOS PORQUE JEHOVA TU DIOS ES EL QUE VA CONTIGO NO TE DEJARA NI TE DESAMPARARA", source: "Deuteronomio 31:6" },
                { text: "FIATE DE JEHOVA DE TODO TU CORAZON Y NO TE APOYES EN TU PROPIA PRUDENCIA", source: "Proverbios 3:5" },
                { text: "VENID A MI TODOS LOS QUE ESTAIS TRABAJADOS Y CARGADOS Y YO OS HARE DESCANSAR", source: "Mateo 11:28" },
                { text: "LA PAZ OS DEJO MI PAZ OS DOY YO NO OS LA DOY COMO EL MUNDO LA DA NO SE TURBE VUESTRO CORAZON NI TENGA MIEDO", source: "Juan 14:27" },
                { text: "PORQUE DONDE ESTAN DOS O TRES CONGREGADOS EN MI NOMBRE ALLI ESTOY YO EN MEDIO DE ELLOS", source: "Mateo 18:20" },
                { text: "PORQUE NADA HAY IMPOSSIBLE PARA DIOS", source: "Lucas 1:37" },
                { text: "BUSCAD PRIMERAMENTE EL REINO DE DIOS Y SU JUSTICIA Y TODAS ESTAS COSAS OS SERAN AÑADIDAS", source: "Mateo 6:33" },
                { text: "Y SABEMOS QUE A LOS QUE AMAN A DIOS TODAS LAS COSAS LES AYUDAN A BIEN ESTO ES A LOS QUE CONFORME A SU PROPOSITO SON LLAMADOS", source: "Romanos 8:28" },
                { text: "PERO EL QUE PERSEVERE HASTA EL FIN ESTE SERA SALVO", source: "Mateo 24:13" },
                { text: "SI PUES LA LUZ QUE EN TI HAY ES TINIEBLAS CUANTAS NO SERAN LAS MISMAS TINIEBLAS", source: "Mateo 6:23" },
                { text: "MAS EL FRUTO DEL ESPIRITU ES AMOR GOZO PAZ PACIENCIA BENIGNIDAD BONDAD FE", source: "Gálatas 5:22" },
                { text: "JEHOVA ES MI LUZ Y MI SALVACION DE QUIEN TEMERE", source: "Salmo 27:1" },
                { text: "EN PAZ ME ACOSTARE Y ASIMISMO DORMIRE PORQUE SOLO TU JEHOVA ME HACES VIVIR CONFIADO", source: "Salmo 4:8" },
                { text: "DIOS ES NUESTRO AMPARO Y FORTALEZA NUESTRO PRONTO AUXILIO EN LAS TRIBULACIONES", source: "Salmo 46:1" },
                { text: "ENCOMENDA A JEHOVA TU CAMINO Y CONFIA EN EL Y EL HARA", source: "Salmo 37:5" },
                { text: "ALZARE MIS OJOS A LOS MONTES DE DONDE VENDRA MI SOCORRO MI SOCORRO VIENE DE JEHOVA QUE HIZO LOS CIELOS Y LA TIERRA", source: "Salmo 121:1-2" },
                { text: "LOS QUE CONFIAN EN JEHOVA SON COMO EL MONTE DE SION QUE NO SE MUEVE SINO QUE PERMANECE PARA SIEMPRE", source: "Salmo 125:1" },
                { text: "CREA EN MI OH DIOS UN CORAZON LIMPIO Y RENUEVA UN ESPIRITU RECTO DENTRO DE MI", source: "Salmo 51:10" },
                { text: "GUSTAD Y VED QUE ES BUENO JEHOVA DICHOSO EL HOMBRE QUE CONFIA EN EL", source: "Salmo 34:8" },
                { text: "PORQUE TU OH JEHOVA ERES BUENO Y AFIN A PERDONAR Y GRANDE EN MISERICORDIA PARA CON TODOS LOS QUE TE INVOCAN", source: "Salmo 86:5" },
                { text: "NO TEMERE MAL ALGUNO PORQUE TU ESTARAS CONMIGO TU VARA Y TU CAYADO ME INFUNDIRAN ALIENTO", source: "Salmo 23:4" },
                { text: "OH SI EL ME BESARA CON BESOS DE SU BOCA PORQUE MEJORES SON TUS AMORES QUE EL VINO", source: "Cantares 1:2" },
                { text: "MI AMADO ES PARA MI UN MANOJITO DE MIRRA QUE REPOSA TODA LA NOCHE ENTRE MIS PECHOS", source: "Cantares 1:13" },
                { text: "HE AQUI QUE TU ERES HERMOSA AMADA MIA HE AQUI QUE ERES BELLA TUS OJOS SON COMO DE PALOMA", source: "Cantares 1:15" },
                { text: "YO SOY LA ROSA DE SARON Y EL LIRIO DE LOS VALLES", source: "Cantares 2:1" },
                { text: "MI AMADO ES MIO Y YO SUYA EL APAZIENTA ENTRE LIRIOS", source: "Cantares 2:16" },
                { text: "LEVANTATE AMADA MIA HERMOSA MIA Y VEN", source: "Cantares 2:10" },
                { text: "PONME COMO UN SELLO SOBRE TU CORAZON COMO UNA MARCA SOBRE TU BRAZO PORQUE FUERTE ES COMO LA MUERTE EL AMOR", source: "Cantares 8:6" },
                { text: "NI LAS MUCHAS AGUAS PODRAN APAGAR EL AMOR NI LO AHOGARAN LOS RIOS", source: "Cantares 8:7" },
                { text: "SU MANO IZQUIERDA ESTE DEBAJO DE MI CABEZA Y SU DERECHA ME ABRAZE", source: "Cantares 8:3" },
                { text: "QUE ES ESTA QUE SUBE DEL DESIERTO COMO COLUMNAS DE HUMO ADEREZADA DE MIRRA Y DE INCIENSO", source: "Cantares 3:6" },
                // --- Citas del Apocalipsis ---
                { text: "YO SOY EL ALFA Y LA OMEGA EL PRINCIPIO Y EL FIN", source: "Apocalipsis 21:6" },
                { text: "BIENAVENTURADOS LOS QUE LAVAN SUS ROPAS PARA TENER DERECHO AL ARBOL DE LA VIDA", source: "Apocalipsis 22:14" },
                { text: "Y ENJUGARA DIOS TODA LAGRIMA DE LOS OJOS DE ELLOS", source: "Apocalipsis 21:4" },
                { text: "HE AQUI YO VENGO PRONTO Y MI GALARDON CONMIGO", source: "Apocalipsis 22:12" },
                { text: "EL QUE VENCIERE NO SUFRIRA DAÑO DE LA SEGUNDA MUERTE", source: "Apocalipsis 2:11" },
                { text: "EL QUE TIENE OIDO OIGA LO QUE EL ESPIRITU DICE A LAS IGLESIAS", source: "Apocalipsis 2:7" },
                { text: "NO TEMAS EN NADA LO QUE VAS A PADECER", source: "Apocalipsis 2:10" },
                { text: "YO ESTOY A LA PUERTA Y LLAMO SI ALGUNO OYE MI VOZ Y ABRE LA PUERTA ENTRARE A EL", source: "Apocalipsis 3:20" },
                { text: "SANTO SANTO SANTO ES EL SEÑOR DIOS TODOPODEROSO EL QUE ERA EL QUE ES Y EL QUE HA DE VENIR", source: "Apocalipsis 4:8" },
                { text: "Y EL SEPTIMO ANGEL TOCO LA TROMPETA", source: "Apocalipsis 11:15" },
                // --- Nuevas citas sobre el Amor de Dios ---
                { text: "EL QUE NO AMA NO HA CONOCIDO A DIOS PORQUE DIOS ES AMOR", source: "1 Juan 4:8" },
                { text: "EN ESTO SE MOSTRO EL AMOR DE DIOS PARA CON NOSOTROS EN QUE DIOS ENVIO A SU HIJO UNIGENITO AL MUNDO PARA QUE VIVAMOS POR EL", source: "1 Juan 4:9" },
                { text: "NADIE TIENE MAYOR AMOR QUE ESTE QUE UNO PONGA SU VIDA POR SUS AMIGOS", source: "Juan 15:13" },
                { text: "MAS DIOS MUESTRA SU AMOR PARA CON NOSOTROS EN QUE SIENDO AUN PECADORES CRISTO MURIO POR NOSOTROS", source: "Romanos 5:8" },
                { text: "PORQUE NADA NOS PODRA SEPARAR DEL AMOR DE DIOS QUE ES EN CRISTO JESUS SEÑOR NUESTRO", source: "Romanos 8:39" },
                { text: "MIRAD CUAL AMOR NOS HA DADO EL PADRE PARA QUE SEAMOS LLAMADOS HIJOS DE DIOS", source: "1 Juan 3:1" },
                { text: "PERO DIOS QUE ES RICO EN MISERICORDIA POR SU GRAN AMOR CON QUE NOS AMO", source: "Efesios 2:4" },
                { text: "JEHOVA SE MANIFESTO A MI HACE YA MUCHO TIEMPO DICIENDO CON AMOR ETERNO TE HE AMADO POR TANTO TE PROLONGE MI MISERICORDIA", source: "Jeremías 31:3" },
                { text: "EL AMOR CUBRIRA MULTITUD DE PECADOS", source: "1 Pedro 4:8" },
                { text: "EN EL AMOR NO HAY TEMOR SINO QUE EL PERFECTO AMOR ECHA FUERA EL TEMOR", source: "1 Juan 4:18" }
            ];
            const alphabetLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZÑ'.split('');

            // --- ESTADO DEL JUEGO ---
            let gameState = {};
            const MAX_REVEALS = 3;
            let backspaceTimer; // Para el borrado continuo

            // --- FUNCIONES PRINCIPALES ---
            function initGame() {
                const quote = quotes[Math.floor(Math.random() * quotes.length)];
                gameState = {
                    solution: quote.text,
                    source: quote.source,
                    cipherMap: {},
                    decipherMap: {},
                    history: [],
                    revealsUsed: 0
                };
                createCipher();
                renderPuzzle();
                updateUI();
                elements.exportPdfTitleInput.value = ''; 
                populateAlphabetCheckboxes();
            }
            
            function createCipher() {
                const alphabet = 'ABCDEFGHIJKLMNÑOPQRSTUVWXYZ'.split('');
                let shuffledAlphabet;
                do {
                    shuffledAlphabet = [...alphabet].sort(() => Math.random() - 0.5);
                } while (alphabet.some((letter, index) => letter === shuffledAlphabet[index]));

                alphabet.forEach((letter, index) => {
                    gameState.cipherMap[letter] = shuffledAlphabet[index];
                    gameState.decipherMap[shuffledAlphabet[index]] = letter;
                });
            }

            function renderPuzzle() {
                elements.puzzleContainer.innerHTML = '';
                const words = gameState.solution.split(' ');

                words.forEach(word => {
                    const wordContainer = document.createElement('div');
                    wordContainer.className = 'word-container';
                    for (const char of word) {
                        if (/[A-ZÑ]/.test(char)) {
                            const encryptedChar = gameState.cipherMap[char];
                            const letterContainer = document.createElement('div');
                            letterContainer.className = 'letter-container';
                            const encryptedLetterSpan = document.createElement('span');
                            encryptedLetterSpan.className = 'encrypted-letter';
                            encryptedLetterSpan.textContent = encryptedChar;
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.maxLength = 1;
                            input.className = 'letter-input w-8 h-8 text-center text-2xl';
                            input.dataset.encrypted = encryptedChar;
                            letterContainer.appendChild(encryptedLetterSpan);
                            letterContainer.appendChild(input);
                            wordContainer.appendChild(letterContainer);
                        } else {
                            const puncSpan = document.createElement('span');
                            puncSpan.className = 'punctuation-mark';
                            puncSpan.textContent = char;
                            wordContainer.appendChild(puncSpan);
                        }
                    }
                    elements.puzzleContainer.appendChild(wordContainer);
                });
            }

            function updateUI() {
                elements.sourceText.textContent = ''; 
                elements.messageText.textContent = '';
                elements.messageText.parentElement.classList.add('opacity-0');
                elements.revealCount.textContent = MAX_REVEALS - gameState.revealsUsed;
                elements.revealLetterBtn.disabled = gameState.revealsUsed >= MAX_REVEALS;
                elements.undoBtn.disabled = gameState.history.length === 0;
            }

            function handleInput(e) {
                if (e.target.tagName !== 'INPUT' || !e.target.dataset.encrypted) return;
                const currentInput = e.target;
                const encryptedChar = currentInput.dataset.encrypted;
                const userGuess = currentInput.value.toUpperCase();

                let previousValue = '';
                const allInputsForChar = document.querySelectorAll(`input[data-encrypted="${encryptedChar}"]`);
                if (allInputsForChar.length > 0) {
                    previousValue = allInputsForChar[0].value;
                }
                
                if (previousValue !== userGuess) {
                    gameState.history.push({ encryptedChar, value: previousValue });
                    elements.undoBtn.disabled = false;
                }

                allInputsForChar.forEach(input => {
                    input.value = userGuess;
                });

                // Mover automáticamente al siguiente input si se ingresó una letra
                if (userGuess && userGuess.length === 1 && /[A-ZÑ]/.test(userGuess)) {
                    const inputs = Array.from(document.querySelectorAll('input.letter-input'));
                    const currentIndex = inputs.indexOf(currentInput);
                    const nextInput = findNextEditableInput(inputs, currentIndex);
                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            }

            function handleKeydown(e) {
                if (e.target.tagName !== 'INPUT' || !e.target.classList.contains('letter-input')) return;

                const currentInput = e.target;
                const inputs = Array.from(document.querySelectorAll('input.letter-input'));
                const currentIndex = inputs.indexOf(currentInput);

                if (e.key === 'Backspace') {
                    // Prevenir el comportamiento por defecto para manejar el borrado continuo
                    e.preventDefault(); 
                    if (currentInput.value === '' && currentIndex > 0) {
                        // Si el input actual está vacío, intentar borrar el anterior
                        const prevInput = findPrevEditableInput(inputs, currentIndex);
                        if (prevInput) {
                            prevInput.value = ''; // Borrar el valor del input anterior
                            const encryptedChar = prevInput.dataset.encrypted;
                            // Actualizar todos los inputs con la misma letra encriptada
                            document.querySelectorAll(`input[data-encrypted="${encryptedChar}"]`).forEach(input => {
                                input.value = '';
                            });
                            prevInput.focus();
                        }
                    } else {
                        // Si el input actual tiene valor, simplemente borrarlo
                        currentInput.value = '';
                        const encryptedChar = currentInput.dataset.encrypted;
                        document.querySelectorAll(`input[data-encrypted="${encryptedChar}"]`).forEach(input => {
                            input.value = '';
                        });
                    }

                    // Iniciar el temporizador para borrado continuo si se mantiene presionado
                    if (!backspaceTimer) {
                        backspaceTimer = setTimeout(() => {
                            // Si se mantiene presionado, cada 100ms se intenta mover y borrar
                            backspaceTimer = setInterval(() => {
                                const focusedInput = document.activeElement;
                                if (focusedInput && focusedInput.classList.contains('letter-input')) {
                                    const focusedIndex = inputs.indexOf(focusedInput);
                                    const prevInput = findPrevEditableInput(inputs, focusedIndex);
                                    if (prevInput) {
                                        prevInput.value = '';
                                        const encryptedChar = prevInput.dataset.encrypted;
                                        document.querySelectorAll(`input[data-encrypted="${encryptedChar}"]`).forEach(input => {
                                            input.value = '';
                                        });
                                        prevInput.focus();
                                    } else {
                                        clearInterval(backspaceTimer); // Detener si no hay más inputs anteriores
                                        backspaceTimer = null;
                                    }
                                } else {
                                    clearInterval(backspaceTimer);
                                    backspaceTimer = null;
                                }
                            }, 100); // Borrar y mover cada 100ms
                        }, 500); // Esperar 500ms antes de iniciar el borrado continuo
                    }
                } else if (e.key === ' ' || e.key === 'Spacebar') { // Manejar la barra espaciadora
                    e.preventDefault(); // Evitar que se escriba un espacio
                    const nextInput = findNextEditableInput(inputs, currentIndex);
                    if (nextInput) {
                        nextInput.focus();
                    }
                } else if (e.key === 'Tab') {
                    // El comportamiento predeterminado de Tab es bueno, pero lo ajustaremos
                    // para saltar inputs deshabilitados.
                    e.preventDefault();
                    if (e.shiftKey) { // Shift + Tab para ir hacia atrás
                        const prevInput = findPrevEditableInput(inputs, currentIndex);
                        if (prevInput) {
                            prevInput.focus();
                        }
                    } else { // Tab para ir hacia adelante
                        const nextInput = findNextEditableInput(inputs, currentIndex);
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                } else if (!/[A-ZÑ]/.test(e.key.toUpperCase()) && e.key.length === 1) {
                    // Prevenir la entrada de caracteres no alfabéticos
                    e.preventDefault();
                }
            }

            function handleKeyup(e) {
                if (e.key === 'Backspace') {
                    clearTimeout(backspaceTimer);
                    clearInterval(backspaceTimer);
                    backspaceTimer = null;
                }
            }

            function findNextEditableInput(inputsArray, startIndex) {
                for (let i = startIndex + 1; i < inputsArray.length; i++) {
                    if (!inputsArray[i].disabled) {
                        return inputsArray[i];
                    }
                }
                return null;
            }

            function findPrevEditableInput(inputsArray, startIndex) {
                for (let i = startIndex - 1; i >= 0; i--) {
                    if (!inputsArray[i].disabled) {
                        return inputsArray[i];
                    }
                }
                return null;
            }
            
            function revealLetter() {
                if (gameState.revealsUsed >= MAX_REVEALS) {
                    showMessage("Has agotado todas tus pistas.", "info");
                    return;
                }
                const unsolvedInputs = Array.from(document.querySelectorAll('input.letter-input:not(:disabled)'))
                                                 .filter(input => input.value === '');
                if (unsolvedInputs.length === 0) {
                    showMessage("Ya has resuelto todas las letras.", "info");
                    return;
                }
                gameState.revealsUsed++;
                const randomInput = unsolvedInputs[Math.floor(Math.random() * unsolvedInputs.length)];
                const encryptedChar = randomInput.dataset.encrypted;
                const correctLetter = gameState.decipherMap[encryptedChar];
                const allInputsForChar = document.querySelectorAll(`input[data-encrypted="${encryptedChar}"]`);
                allInputsForChar.forEach(input => {
                    input.value = correctLetter;
                    input.disabled = true;
                    input.classList.add('font-bold');
                });
                updateUI();
            }

            function undoLastMove() {
                if (gameState.history.length === 0) return;
                const lastAction = gameState.history.pop();
                const inputsToRevert = document.querySelectorAll(`input[data-encrypted="${lastAction.encryptedChar}"]`);
                inputsToRevert.forEach(input => {
                    // Solo revertir si no está deshabilitado (revelado)
                    if (!input.disabled) { 
                        input.value = lastAction.value;
                    }
                });
                elements.undoBtn.disabled = gameState.history.length === 0;
            }

            function checkSolution() {
                const userSolution = Array.from(elements.puzzleContainer.querySelectorAll('.word-container'))
                    .map(wordDiv => {
                        return Array.from(wordDiv.children).map(child => {
                            if (child.classList.contains('letter-container')) {
                                return child.querySelector('input').value.toUpperCase() || '_';
                            }
                            return child.textContent;
                        }).join('');
                    }).join(' ');

                if (userSolution === gameState.solution) {
                    showMessage("¡Correcto! ¡Has descifrado la cita!", "success");
                    elements.sourceText.textContent = gameState.source;
                    document.querySelectorAll('input.letter-input').forEach(input => input.disabled = true);
                } else {
                    showMessage("Aún no es correcto. ¡Sigue intentando!", "error");
                }
            }
            
            async function exportPuzzle() {
                const { jsPDF } = window.jspdf;
                const exportBtnInModal = elements.generatePdfBtn;
                const contentToExport = elements.mainContent;
                
                // Guardar el estado original de visibilidad de los títulos del juego
                const wasGameMainTitleHidden = elements.gameMainTitle.classList.contains('hidden');
                const wasGameSubtitleHidden = elements.gameSubtitle.classList.contains('hidden');


                const pdfTitle = elements.exportPdfTitleInput.value.trim() || 'Criptograma Bíblico';
                const lettersToRevealInPdf = getSelectedLettersToReveal();

                // --- PREPARAR EL PUZZLE PARA LA EXPORTACIÓN ---
                const exportTitleDiv = document.createElement('div');
                exportTitleDiv.className = 'export-title'; 
                exportTitleDiv.textContent = pdfTitle;

                // Insertar el título al principio del main-content
                contentToExport.prepend(exportTitleDiv);

                // Ocultar el título y subtítulo originales del juego para evitar duplicidad
                elements.gameMainTitle.classList.add('hidden');
                elements.gameSubtitle.classList.add('hidden');

                // Guardar el estado actual de los inputs
                const currentInputStates = {};
                document.querySelectorAll('input.letter-input').forEach(input => {
                    currentInputStates[input.dataset.encrypted] = {
                        value: input.value,
                        disabled: input.disabled,
                        classList: Array.from(input.classList)
                    };
                });

                // Modificar inputs temporalmente para la exportación según la configuración del modal
                document.querySelectorAll('input.letter-input').forEach(input => {
                    const encryptedChar = input.dataset.encrypted;
                    const correctLetter = gameState.decipherMap[encryptedChar];

                    if (lettersToRevealInPdf.includes(correctLetter)) {
                        input.value = correctLetter;
                        input.disabled = true;
                        input.classList.add('font-bold');
                        input.classList.add('bg-green-100');
                    } else if (!currentInputStates[encryptedChar].disabled && currentInputStates[encryptedChar].value === '') {
                         input.value = '';
                    }
                });
                // --- FIN DE PREPARACIÓN ---

                exportBtnInModal.disabled = true;
                exportBtnInModal.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generando...`;
                
                elements.exportConfigModal.classList.add('hidden');
                document.getElementById('controls').style.display = 'none'; 


                try {
                    const canvas = await html2canvas(contentToExport, {
                        scale: 2, 
                        backgroundColor: '#D4AF37' /* Usar el nuevo color de fondo para el PDF */
                    });
                    const imgData = canvas.toDataURL('image/png');
                    
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });

                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`${pdfTitle}.pdf`);
                } catch (error) {
                    console.error("Error al exportar:", error);
                    showMessage("Ocurrió un error al exportar el archivo.", "error");
                } finally {
                    // --- RESTAURAR ESTADO ORIGINAL DE LOS INPUTS Y UI ---
                    document.querySelectorAll('input.letter-input').forEach(input => {
                        const encryptedChar = input.dataset.encrypted;
                        if (currentInputStates[encryptedChar]) {
                            input.value = currentInputStates[encryptedChar].value;
                            input.disabled = currentInputStates[encryptedChar].disabled;
                            input.className = currentInputStates[encryptedChar].classList.join(' ');
                        }
                    });

                    // Eliminar el título temporal de exportación
                    if (exportTitleDiv && exportTitleDiv.parentNode) {
                        exportTitleDiv.parentNode.removeChild(exportTitleDiv);
                    }
                    // Restaurar la visibilidad original de los títulos del juego
                    if (!wasGameMainTitleHidden) {
                        elements.gameMainTitle.classList.remove('hidden');
                    }
                    if (!wasGameSubtitleHidden) {
                        elements.gameSubtitle.classList.remove('hidden');
                    }

                    document.getElementById('controls').style.display = '';
                    exportBtnInModal.disabled = false;
                    exportBtnInModal.innerHTML = `<i class="fa-solid fa-file-pdf mr-2"></i>Generar PDF`;
                }
            }

            function showMessage(text, type) {
                elements.messageText.textContent = text;
                elements.messageText.parentElement.classList.remove('opacity-0');
                const colors = { 
                    success: 'text-green-700', 
                    error: 'text-red-600', 
                    info: 'text-amber-700' 
                };
                elements.messageText.className = `text-xl font-semibold ${colors[type] || colors.info}`;
                setTimeout(() => elements.messageText.parentElement.classList.add('opacity-0'), 4000);
            }

            function openExportModal() {
                elements.exportConfigModal.classList.remove('hidden');
                if (!elements.exportPdfTitleInput.value.trim()) {
                    elements.exportPdfTitleInput.value = 'Criptograma Bíblico';
                }
                elements.alphabetCheckboxesContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }

            function closeExportModal() {
                elements.exportConfigModal.classList.add('hidden');
            }

            function populateAlphabetCheckboxes() {
                elements.alphabetCheckboxesContainer.innerHTML = '';
                alphabetLetters.forEach(letter => {
                    const div = document.createElement('div');
                    div.className = 'alphabet-item';
                    div.innerHTML = `
                        <input type="checkbox" id="reveal-checkbox-${letter}" value="${letter}" class="mr-1">
                        <label for="reveal-checkbox-${letter}">${letter}</label>
                    `;
                    elements.alphabetCheckboxesContainer.appendChild(div);
                });
            }

            function getSelectedLettersToReveal() {
                const selectedLetters = [];
                elements.alphabetCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedLetters.push(checkbox.value);
                });
                return selectedLetters;
            }

            // --- EVENT LISTENERS ---
            elements.newGameBtn.addEventListener('click', initGame);
            elements.revealLetterBtn.addEventListener('click', revealLetter);
            elements.checkSolutionBtn.addEventListener('click', checkSolution);
            elements.puzzleContainer.addEventListener('input', handleInput);
            elements.puzzleContainer.addEventListener('keydown', handleKeydown); // Nuevo listener para keydown
            elements.puzzleContainer.addEventListener('keyup', handleKeyup);     // Nuevo listener para keyup
            elements.undoBtn.addEventListener('click', undoLastMove);
            elements.openExportModalBtn.addEventListener('click', openExportModal);
            elements.closeModalBtn.addEventListener('click', closeExportModal);
            elements.generatePdfBtn.addEventListener('click', exportPuzzle);

            window.addEventListener('click', (event) => {
                if (event.target == elements.exportConfigModal) {
                    closeExportModal();
                }
            });

            // --- INICIAR JUEGO ---
            initGame();
        });
    </script>
</body>
</html>